<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login, Cadastro e Perfil com Persistência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilização para Placeholders no Dark Mode Padrão (Melhor legibilidade) */
        input::placeholder {
            color: #9ca3af; /* gray-400 */
            opacity: 1; 
        }
        /* Ajuste do Select no Dark Mode: garante que o texto seja claro */
        select {
            color: white; 
        }
        /* Ajuste do Select no Light Mode: garante que o texto seja escuro */
        .light select {
            color: #4b5563; /* gray-700 */
        }
        /* Estilo para tags (chips) */
        .food-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        /* Remove a barra de rolagem dos textareas, se houver, garantindo que o body role. */
        textarea {
            overflow: hidden; /* Oculta a barra de rolagem padrão se não for necessário */
            resize: vertical; /* Permite redimensionar apenas verticalmente */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 transition-colors duration-300 bg-gray-900"> 

    <div id="auth-card" class="mx-auto w-full p-8 sm:p-10 rounded-xl shadow-2xl transition-all duration-300 dark:shadow-none border border-gray-700 bg-gray-800 text-gray-200 max-w-md">
        
        <div class="flex justify-end mb-4">
            <button id="theme-toggle" class="p-2 rounded-full text-gray-300 hover:text-indigo-400 transition duration-300">
                <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>

        <div id="message-area" class="mb-4 hidden p-3 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

        <div id="login-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Acesse sua Conta</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">E-mail</label>
                    <input type="email" id="login-email" placeholder="seu@email.com" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Senha</label>
                    <input type="password" id="login-password" placeholder="••••••••" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                
                <button type="submit"
                         class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md">
                    Entrar
                </button>
            </form>

            <div class="my-6 flex items-center">
                <div class="flex-grow border-t border-gray-700 light:border-gray-300"></div>
                <span class="flex-shrink mx-4 text-sm dark:text-gray-400 light:text-gray-500">OU</span>
                <div class="flex-grow border-t border-gray-700 light:border-gray-300"></div>
            </div>

            <button id="google-login-btn"
                     class="w-full flex items-center justify-center py-2 px-4 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg shadow-sm text-sm font-medium dark:text-gray-200 light:text-gray-700 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 hover:bg-gray-600 light:hover:bg-gray-200 transition duration-150">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.684,43.868,21.327,43.611,20.083z"/>
                    <path fill="#FF3D00" d="M6.306 14.691L11.41 18.257C13.204 16.292 14.004 14.072 14.004 12C14.004 9.928 13.204 7.708 11.41 5.743L6.306 9.309C5.541 10.334 5.148 11.167 5.148 12C5.148 12.833 5.541 13.666 6.306 14.691z"/>
                    <path fill="#4CAF50" d="M24 44C12.955 44 4 35.045 4 24C4 22.684 4.132 21.327 4.389 20.083H1.944C1.353 21.378 1 22.673 1 24C1 37.807 12.193 49 26 49C29.626 49 33.024 48.219 35.91 46.853L30.253 42.275C28.483 43.141 26.242 43.5 24 43.5z"/>
                    <path fill="#1976D2" d="M43.611 20.083C43.868 21.327 44 22.684 44 24C44 25.316 43.868 26.673 43.611 27.917L42 27.917L30.253 32.535C30.253 32.535 30.253 32.535 30.253 32.535L35.91 37.113C38.796 35.747 41.677 32.866 43.611 27.917z"/>
                </svg>
                Entrar com Google
            </button>

            <p class="mt-6 text-center text-sm dark:text-gray-400 light:text-gray-600">
                Não tem uma conta?
                <a href="#" id="show-register-link" class="font-medium text-indigo-400 hover:text-indigo-300 dark:text-indigo-400 light:text-indigo-600">
                    Criar conta
                </a>
            </p>
        </div>

        <div id="register-view" class="view hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Crie sua Conta</h2>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Nome Completo</label>
                    <input type="text" id="register-name" placeholder="Seu Nome" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">E-mail</label>
                    <input type="email" id="register-email" placeholder="seu@email.com" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Senha</label>
                    <input type="password" id="register-password" placeholder="Mínimo 6 caracteres" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-confirm-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Confirme a Senha</label>
                    <input type="password" id="register-confirm-password" placeholder="Repita a senha" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                
                <button type="submit"
                         class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition duration-150 shadow-md">
                    Criar Conta
                </button>
            </form>

            <p class="mt-6 text-center text-sm dark:text-gray-400 light:text-gray-600">
                Já tem uma conta?
                <a href="#" id="show-login-link" class="font-medium text-indigo-400 hover:text-indigo-300 dark:text-indigo-400 light:text-indigo-600">
                    Fazer Login
                </a>
            </p>
        </div>
        
        <div id="info-form-view" class="view hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Seu Perfil</h2>
            <p class="text-center dark:text-gray-400 light:text-gray-500 mb-6">Preencha ou atualize seus dados.</p>
            
            <form id="info-form" class="space-y-4">

                <div>
                    <label for="user-type-input" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Tipo de Usuário</label>
                    <select id="user-type-input" required
                             class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                        <option value="" disabled selected>Selecione seu papel (Aluno ou Personal)</option>
                        <option value="aluno">Aluno</option>
                        <option value="personal">Personal Trainer</option>
                    </select>
                </div>
                
                <div>
                    <label for="full-name" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Nome Completo</label>
                    <input type="text" id="full-name" placeholder="Nome Completo" 
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>

                <div id="aluno-metrics-fields" class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="age" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Idade</label>
                        <input type="number" id="age" placeholder="Ex: 30" min="1" max="150" required
                               class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>

                    <div>
                        <label for="gender" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Gênero</label>
                        <select id="gender" required
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                            <option value="" disabled selected>Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                        </select>
                    </div>
                    
                    <div id="objective-field-container">
                        <label for="objective" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Objetivo</label>
                        <select id="objective" required
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                            <option value="" disabled selected>Selecione seu objetivo principal</option>
                            <option value="emagrecer">Emagrecer</option>
                            <option value="massa_muscular">Obter Massa Muscular</option>
                        </select>
                    </div>

                    <div class="hidden">
                        </div>

                    <div>
                        <label for="weight" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Peso (kg)</label>
                        <input type="number" id="weight" placeholder="Ex: 75.5" step="0.1" min="1" 
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>

                    <div>
                        <label for="height" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Altura (cm)</label>
                        <input type="number" id="height" placeholder="Ex: 175" step="1" min="50" 
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>
                </div>

                <div id="aluno-fields" class="space-y-4 hidden pt-2 border-t border-dashed border-gray-600/50 light:border-gray-300/50">
                    <p class="text-sm dark:text-gray-400 light:text-gray-700 font-semibold pt-2">Informações Adicionais (Aluno)</p>

                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Limitações Físicas (Selecione uma ou mais)</label>
                        <div id="selected-limitations-tags" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus-within:border-indigo-500 transition duration-150 bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100/50">
                            <span id="no-limitations-selected" class="text-sm dark:text-gray-400 light:text-gray-500">Nenhuma limitação selecionada.</span>
                        </div>
                        
                        <button type="button" id="add-limitation-btn"
                                class="mt-2 w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition duration-150 flex items-center justify-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Adicionar/Editar Limitações
                        </button>
                        <p class="text-xs dark:text-gray-500 light:text-gray-500 mt-1">Clique acima para selecionar as limitações aplicáveis.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Alimentos que Não Gosta/Não Pode Comer</label>
                        <div id="selected-food-tags" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus-within:border-indigo-500 transition duration-150 bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100/50">
                            <span id="no-foods-selected" class="text-sm dark:text-gray-400 light:text-gray-500">Nenhum alimento selecionado.</span>
                        </div>
                        
                        <button type="button" id="add-food-restriction-btn"
                                class="mt-2 w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition duration-150 flex items-center justify-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Adicionar/Editar Alimentos
                        </button>
                        <p class="text-xs dark:text-gray-500 light:text-gray-500 mt-1">Clique acima para selecionar múltiplos alimentos.</p>
                    </div>
                </div>

                <button type="submit" id="save-info-btn"
                         class="w-full py-2 px-4 mt-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md">
                    Salvar Informações
                </button>
            </form>
        </div>
        
        <div id="plan-generation-view" class="view hidden text-center p-8">
            <svg class="mx-auto h-16 w-16 text-indigo-500 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4" id="generation-message-title">Gerando Plano de Ação...</h2>
            <p class="mt-2 dark:text-gray-400 light:text-gray-600" id="generation-message-text">Estamos criando sua rotina alimentar e de treino, baseada em seus dados e restrições. Isso levará apenas alguns segundos.</p>
        </div>

        <div id="student-dashboard-view" class="view hidden p-4 sm:p-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 tracking-tight">Dashboard do Aluno</h2>
            <p class="dark:text-gray-400 light:text-gray-600 mb-8 border-b border-gray-700/50 light:border-gray-300/50 pb-4">Seu resumo de saúde e planos de ação.</p>

            <div class="space-y-8">
                <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-indigo-500/30">
                    <h3 class="text-2xl font-semibold mb-4 dark:text-indigo-400 light:text-indigo-900 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Acesso e Identificação
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-6 text-base">
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Nome:</span> <span id="student-dashboard-name" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">E-mail:</span> <span id="student-dashboard-email" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <div class="sm:col-span-2">
                            <p class="font-medium text-gray-500 dark:text-gray-300 mb-1">Seu Código Único (Para Personal Trainer):</p>
                            <span id="student-dashboard-client-code" class="font-mono bg-gray-200 dark:bg-gray-900/50 p-2 rounded text-sm text-green-700 dark:text-green-400 select-all break-all block"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-indigo-500/30">
                    <h3 class="text-2xl font-semibold mb-4 dark:text-indigo-400 light:text-indigo-900 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h7m0 0l-9 9" /></svg>
                        Dados do Perfil
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-y-4 gap-x-6 text-base mb-6">
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Idade:</span> <span id="student-dashboard-age" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Gênero:</span> <span id="student-dashboard-gender" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Objetivo:</span> <span id="student-dashboard-objective" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Peso:</span> <span id="student-dashboard-weight" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Altura:</span> <span id="student-dashboard-height" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <div class="sm:col-span-3">
                            <p class="font-medium text-gray-500 dark:text-gray-300 mb-1">Limitações Físicas:</p>
                            <div id="student-dashboard-limitations" class="flex flex-wrap gap-2 pt-1"></div>
                        </div>
                        <div class="sm:col-span-3">
                            <p class="font-medium text-gray-500 dark:text-gray-300 mb-1">Restrições Alimentares:</p>
                            <div id="student-dashboard-restrictions" class="flex flex-wrap gap-2 pt-1"></div>
                        </div>
                    </div>
                    <button id="edit-profile-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 w-full sm:w-auto">
                        Editar Informações do Perfil
                    </button>
                    <button id="regenerate-plan-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition duration-150 w-full sm:w-auto mt-2 sm:mt-0 sm:ml-4">
                        Gerar Novo Plano
                    </button>
                </div>


                <div class="space-y-6">
                    <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-pink-500/50">
                        <h3 class="text-3xl font-bold mb-4 dark:text-pink-400 light:text-pink-900 flex items-center border-b border-gray-300 dark:border-gray-600 pb-2">
                            <svg class="w-7 h-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 3h5v5M18 10a8 8 0 11-16 0 8 8 0 0116 0z" /></svg>
                            Plano Alimentar
                        </h3>
                        <pre id="student-food-routine" class="text-base text-gray-900 dark:text-gray-200 whitespace-pre-wrap font-sans leading-relaxed p-4 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-400 dark:border-gray-600"></pre>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-green-500/50">
                        <h3 class="text-3xl font-bold mb-4 dark:text-green-400 light:text-green-900 flex items-center border-b border-gray-300 dark:border-gray-600 pb-2">
                            <svg class="w-7 h-7 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            Plano de Treino
                        </h3>
                        <pre id="student-training-routine" class="text-base text-gray-900 dark:text-gray-200 whitespace-pre-wrap font-sans leading-relaxed p-4 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-400 dark:border-gray-600"></pre>
                    </div>
                </div>
            </div>

            <button id="student-logout-btn" class="mt-10 py-3 px-6 rounded-lg text-white font-bold bg-red-600 hover:bg-red-700 transition duration-200 shadow-xl shadow-red-900/50 w-full tracking-wide">
                Sair do Dashboard
            </button>
        </div>

        <div id="personal-dashboard-view" class="view hidden p-4 sm:p-8">
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 tracking-tight">Dashboard Personal Trainer</h2>
            <p class="dark:text-gray-400 light:text-gray-600 mb-8 border-b border-gray-700/50 light:border-gray-300/50 pb-4">Gerencie e edite os planos de seus alunos.</p>

            <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-300 dark:border-indigo-500/50 mb-8">
                <h3 class="text-2xl font-semibold mb-4 dark:text-indigo-400 light:text-indigo-900 flex items-center border-b border-gray-300 dark:border-gray-600 pb-2">
                    <svg class="w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    Acessar Perfil do Aluno
                </h3>
                <form id="search-student-form" class="space-y-5">
                    <div>
                        <label for="student-uid-search" class="block text-sm font-medium mb-2 text-gray-500 dark:text-gray-300">Código Único do Aluno (7 caracteres)</label>
                        <input type="text" id="student-uid-search" placeholder="Ex: A7D2F4G" required maxlength="7"
                               class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 font-mono placeholder-gray-500 dark:placeholder-gray-500 light:placeholder-gray-400 uppercase">
                    </div>
                    <button type="submit"
                             class="w-full py-3 px-4 rounded-lg text-white font-bold bg-green-600 hover:bg-green-700 transition duration-200 shadow-lg shadow-green-900/50 tracking-wide">
                        Buscar Aluno e Abrir Edição
                    </button>
                </form>
            </div>

            <div id="personal-student-profile" class="hidden bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-300 dark:border-yellow-500/50">
                <h3 class="text-2xl font-bold mb-6 dark:text-white light:text-gray-900 border-b border-gray-300 dark:border-gray-700 pb-3">
                    Editando: <span id="editing-student-name" class="text-yellow-800 dark:text-yellow-400"></span>
                </h3>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-4 gap-x-6 text-base mb-6 p-4 rounded-lg border border-gray-600 dark:border-gray-700 bg-gray-100 dark:bg-gray-800">
                    <h4 class="sm:col-span-2 lg:col-span-3 text-lg font-bold dark:text-indigo-400 light:text-indigo-700 mb-2">Dados do Aluno:</h4>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">E-mail:</span> <span id="personal-student-email" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">Idade:</span> <span id="personal-student-age" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">Gênero:</span> <span id="personal-student-gender" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">Objetivo:</span> <span id="personal-student-objective" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">Peso:</span> <span id="personal-student-weight" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <p><span class="font-medium text-gray-500 dark:text-gray-300">Altura:</span> <span id="personal-student-height" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    <div class="sm:col-span-3">
                        <p class="font-medium text-gray-500 dark:text-gray-300 mb-1">Limitações Físicas:</p>
                        <div id="personal-student-limitations" class="flex flex-wrap gap-2 pt-1"></div>
                    </div>
                    <div class="sm:col-span-3">
                        <p class="font-medium text-gray-500 dark:text-gray-300 mb-1">Restrições Alimentares:</p>
                        <div id="personal-student-restrictions" class="flex flex-wrap gap-2 pt-1"></div>
                    </div>
                </div>

                <form id="edit-student-routine-form" class="space-y-6">
                    <div>
                        <label for="edit-food-routine" class="block text-xl font-medium mb-2 dark:text-pink-400 light:text-pink-900 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 3h5v5M18 10a8 8 0 11-16 0 8 8 0 0116 0z" /></svg>
                            Plano Alimentar (Edição)
                        </label>
                        <textarea id="edit-food-routine" rows="10" placeholder="Insira o plano alimentar detalhado para o aluno..."
                                  class="w-full px-4 py-3 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900"></textarea>
                    </div>

                    <div>
                        <label for="edit-training-routine" class="block text-xl font-medium mb-2 dark:text-green-400 light:text-green-900 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            Plano de Treino (Edição)
                        </label>
                        <textarea id="edit-training-routine" rows="10" placeholder="Insira o plano de treino detalhado para o aluno..."
                                  class="w-full px-4 py-3 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900"></textarea>
                    </div>

                    <button type="submit"
                             class="w-full py-3 px-6 rounded-lg text-gray-900 dark:text-gray-900 font-bold bg-yellow-400 hover:bg-yellow-500 transition duration-200 shadow-xl shadow-yellow-900/50 tracking-wide">
                        Salvar e Atualizar Plano do Aluno
                    </button>
                    <button type="button" id="regenerate-student-plan-btn"
                             class="w-full py-3 px-6 rounded-lg text-white font-bold bg-indigo-600 hover:bg-indigo-700 transition duration-200 shadow-lg shadow-indigo-900/50 tracking-wide mt-2">
                        Gerar Plano com IA (Preencher acima)
                    </button>
                </form>
                
            </div>

            <button id="personal-logout-btn" class="mt-10 py-3 px-6 rounded-lg text-white font-bold bg-red-600 hover:bg-red-700 transition duration-200 shadow-xl shadow-red-900/50 w-full tracking-wide">
                Sair do Dashboard
            </button>
        </div>

    </div>

    <div id="food-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold dark:text-white mb-4">Adicionar/Remover Restrições Alimentares</h3>
            <p class="text-sm dark:text-gray-400 mb-4">Selecione os alimentos que você não gosta, não pode comer, ou tem alergia.</p>
            
            <div class="mb-4">
                <input type="text" id="food-search-input" placeholder="Pesquisar alimento ou digitar um novo..."
                       class="w-full px-4 py-2 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 text-white">
            </div>

            <div id="food-suggestions" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-2 bg-gray-700/50 rounded-lg mb-4">
                </div>
            
            <h4 class="text-lg font-semibold dark:text-gray-200 mb-2">Restrições Selecionadas:</h4>
            <div id="current-food-selection" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 rounded-lg bg-gray-700/50 mb-4">
                <span id="food-modal-no-selection" class="text-sm dark:text-gray-400">Nenhuma restrição selecionada.</span>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" id="close-food-modal-btn"
                        class="py-2 px-4 rounded-lg text-gray-300 font-semibold bg-gray-600 hover:bg-gray-700 transition duration-150">
                    Cancelar
                </button>
                <button type="button" id="save-food-restrictions-btn"
                        class="py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                    Salvar Restrições
                </button>
            </div>
        </div>
    </div>

    <div id="limitations-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold dark:text-white mb-4">Adicionar/Remover Limitações Físicas</h3>
            <p class="text-sm dark:text-gray-400 mb-4">Selecione as condições ou lesões que limitam certos exercícios.</p>
            
            <div id="limitation-suggestions-container" class="space-y-3 max-h-72 overflow-y-auto p-3 bg-gray-700/50 rounded-lg mb-4">
                </div>
            
            <h4 class="text-lg font-semibold dark:text-gray-200 mb-2">Limitações Selecionadas:</h4>
            <div id="current-limitations-selection" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 rounded-lg bg-gray-700/50 mb-4">
                <span id="limitations-modal-no-selection" class="text-sm dark:text-gray-400">Nenhuma limitação selecionada.</span>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" id="close-limitations-modal-btn"
                        class="py-2 px-4 rounded-lg text-gray-300 font-semibold bg-gray-600 hover:bg-gray-700 transition duration-150">
                    Cancelar
                </button>
                <button type="button" id="save-limitations-btn"
                        class="py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                    Salvar Limitações
                </button>
            </div>
        </div>
    </div>
    
    <div id="personal-ai-plan-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-gray-800 dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
            <h3 class="text-2xl font-bold dark:text-white mb-4">Gerar Plano de Ação com IA</h3>
            <p class="text-sm dark:text-gray-400 mb-6">A IA criará um plano (Dieta e Treino) com base nos dados do aluno. Você poderá editar o resultado antes de salvar.</p>

            <div class="p-4 rounded-lg bg-gray-700 border border-gray-600 mb-6 space-y-2">
                <h4 class="text-lg font-semibold dark:text-yellow-400">Dados Usados:</h4>
                <p class="text-sm dark:text-gray-300"><strong>Nome:</strong> <span id="ai-plan-student-name"></span></p>
                <p class="text-sm dark:text-gray-300"><strong>Objetivo:</strong> <span id="ai-plan-student-objective"></span></p>
                <p class="text-sm dark:text-gray-300"><strong>Limitações:</strong> <span id="ai-plan-student-limitations"></span></p>
                <p class="text-sm dark:text-gray-300"><strong>Restrições Alimentares:</strong> <span id="ai-plan-student-restrictions"></span></p>
            </div>
            
            <p id="ai-plan-modal-message" class="dark:text-white mb-4 text-center hidden">Gerando plano...</p>
            
            <div class="flex justify-end space-x-3">
                <button type="button" id="close-ai-plan-modal-btn"
                        class="py-2 px-4 rounded-lg text-gray-300 font-semibold bg-gray-600 hover:bg-gray-700 transition duration-150">
                    Fechar
                </button>
                <button type="button" id="start-ai-generation-btn"
                        class="py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition duration-150">
                    Iniciar Geração de Plano
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { GoogleGenAI } from "https://cdn.jsdelivr.net/npm/@google/genai@0.1.0/dist/index.min.js";

        // --- Configuração do Firebase e da IA ---

        // Configurações do Firebase (Substitua com suas próprias chaves)
        // OBS: Para a demonstração, esta chave é fictícia ou genérica, 
        // em um ambiente de produção, use suas credenciais do Firebase.
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // Substitua
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN", // Substitua
            projectId: "YOUR_FIREBASE_PROJECT_ID", // Substitua
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET", // Substitua
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID", // Substitua
            appId: "YOUR_FIREBASE_APP_ID" // Substitua
        };

        // Configuração da Google GenAI (Substitua com sua chave)
        // OBS: Para a demonstração local, você pode usar uma chave de teste ou 
        // garantir que o ambiente tenha acesso seguro à chave.
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY"; // Substitua
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        // Inicializar Google GenAI
        const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });
        const model = "gemini-2.5-flash"; // Modelo mais rápido e ideal para esta tarefa

        // --- Elementos DOM ---
        const authCard = document.getElementById('auth-card');
        const messageArea = document.getElementById('message-area');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const infoForm = document.getElementById('info-form');
        const userTypeInput = document.getElementById('user-type-input');
        const alunoFields = document.getElementById('aluno-fields');
        const alunoMetricsFields = document.getElementById('aluno-metrics-fields');
        const studentDashboardView = document.getElementById('student-dashboard-view');
        const personalDashboardView = document.getElementById('personal-dashboard-view');
        const planGenerationView = document.getElementById('plan-generation-view');
        const studentLogoutBtn = document.getElementById('student-logout-btn');
        const personalLogoutBtn = document.getElementById('personal-logout-btn');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const regeneratePlanBtn = document.getElementById('regenerate-plan-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        
        // Elementos de Modais
        const foodModal = document.getElementById('food-modal');
        const addFoodRestrictionBtn = document.getElementById('add-food-restriction-btn');
        const closeFoodModalBtn = document.getElementById('close-food-modal-btn');
        const foodSearchInput = document.getElementById('food-search-input');
        const foodSuggestionsContainer = document.getElementById('food-suggestions');
        const currentFoodSelectionContainer = document.getElementById('current-food-selection');
        const saveFoodRestrictionsBtn = document.getElementById('save-food-restrictions-btn');
        
        const limitationsModal = document.getElementById('limitations-modal');
        const addLimitationBtn = document.getElementById('add-limitation-btn');
        const closeLimitationsModalBtn = document.getElementById('close-limitations-modal-btn');
        const limitationSuggestionsContainer = document.getElementById('limitation-suggestions-container');
        const saveLimitationsBtn = document.getElementById('save-limitations-btn');

        const personalStudentProfile = document.getElementById('personal-student-profile');
        const searchStudentForm = document.getElementById('search-student-form');
        const editStudentRoutineForm = document.getElementById('edit-student-routine-form');
        const regenerateStudentPlanBtn = document.getElementById('regenerate-student-plan-btn');
        const personalAiPlanModal = document.getElementById('personal-ai-plan-modal');
        const closeAiPlanModalBtn = document.getElementById('close-ai-plan-modal-btn');
        const startAiGenerationBtn = document.getElementById('start-ai-generation-btn');

        // --- Constantes para Modais ---
        const PREDEFINED_FOODS = [
            "Glúten", "Lactose (Leite de vaca)", "Ovos", "Amendoim", "Nozes", "Castanhas", 
            "Frutos do Mar", "Soja", "Trigo", "Carne Vermelha", "Açúcar", "Café", 
            "Pimenta", "Alho", "Cebola", "Tomate", "Beringela", "Batata Doce",
            "Mandioca (Aipim)", "Feijão", "Chocolate", "Bebidas Açucaradas"
        ];

        const PREDEFINED_LIMITATIONS = [
            { id: 'l_lombar', label: 'Problemas na Coluna/Lombar', checked: false },
            { id: 'l_joelho', label: 'Problemas no Joelho', checked: false },
            { id: 'l_ombro', label: 'Problemas no Ombro/Manguito', checked: false },
            { id: 'l_cardiaco', label: 'Condição Cardíaca', checked: false },
            { id: 'l_asma', label: 'Asma/Problemas Respiratórios', checked: false },
            { id: 'l_gravidez', label: 'Gravidez', checked: false },
            { id: 'l_diabete', label: 'Diabetes', checked: false },
            { id: 'l_hipertensao', label: 'Hipertensão', checked: false },
            { id: 'l_outros', label: 'Outras Limitações/Lesões', checked: false }
        ];

        let selectedFoodRestrictions = [];
        let selectedLimitations = [];
        let currentStudentData = null; // Armazena os dados do aluno do personal trainer
        let isGeneratingPlan = false;

        // --- Funções de UI ---

        /**
         * Alterna a view principal exibida (login, register, info, student, personal)
         * @param {string} viewName 
         */
        function toggleView(viewName) {
            const views = ['login-view', 'register-view', 'info-form-view', 'student-dashboard-view', 'personal-dashboard-view', 'plan-generation-view'];
            views.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    view.classList.add('hidden');
                }
            });

            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                // Ajusta o tamanho do card principal para dashboards (maior)
                if (viewName.includes('dashboard')) {
                    authCard.classList.remove('max-w-md');
                    authCard.classList.add('max-w-5xl', 'w-full');
                } else {
                    authCard.classList.remove('max-w-5xl', 'w-full');
                    authCard.classList.add('max-w-md');
                }
            }
        }
        
        /**
         * Exibe uma mensagem de status (sucesso/erro)
         * @param {string} message 
         * @param {string} type 
         */
        function displayMessage(message, type = 'error') {
            messageArea.textContent = message;
            messageArea.classList.remove('hidden', 'bg-red-900', 'text-red-300', 'bg-green-900', 'text-green-300');
            
            if (type === 'success') {
                messageArea.classList.add('bg-green-700', 'text-white');
            } else if (type === 'warning') {
                messageArea.classList.add('bg-yellow-700', 'text-white');
            } else {
                messageArea.classList.add('bg-red-700', 'text-white');
            }

            // Oculta a mensagem após 5 segundos
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        /**
         * Alterna entre Dark e Light mode
         */
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            if (isDark) {
                html.classList.remove('dark');
                html.classList.add('light');
                document.getElementById('moon-icon').classList.add('hidden');
                document.getElementById('sun-icon').classList.remove('hidden');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                document.getElementById('moon-icon').classList.remove('hidden');
                document.getElementById('sun-icon').classList.add('hidden');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        /**
         * Aplica o tema salvo no localStorage ou o padrão (dark)
         */
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            html.classList.remove('light', 'dark');
            html.classList.add(savedTheme);
            
            if (savedTheme === 'light') {
                document.getElementById('moon-icon').classList.add('hidden');
                document.getElementById('sun-icon').classList.remove('hidden');
            } else {
                document.getElementById('moon-icon').classList.remove('hidden');
                document.getElementById('sun-icon').classList.add('hidden');
            }
        }

        // Aplica o tema na inicialização
        applyTheme();

        // --- Funções de Persistência (Firebase) ---

        /**
         * Gera um UID curto de 7 caracteres (A-Z, 0-9)
         * @returns {string}
         */
        function generateShortUid() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 7; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }


        /**
         * Cria um novo documento de usuário no Firestore
         * @param {object} user - Objeto user do Firebase Auth
         * @param {string} name - Nome do usuário
         */
        async function createNewUserDoc(user, name) {
            try {
                const shortUid = generateShortUid();
                const userRef = doc(db, "users", user.uid);
                await setDoc(userRef, {
                    name: name,
                    email: user.email,
                    uid: user.uid,
                    shortUid: shortUid, // Código único para Personal Trainer
                    userType: null, // 'aluno' ou 'personal'
                    isProfileComplete: false,
                    profile: {
                        age: null,
                        gender: null,
                        objective: null,
                        weight: null,
                        height: null,
                        limitations: [],
                        foodRestrictions: [],
                    },
                    routines: {
                        food: null,
                        training: null,
                    }
                });
                return { success: true, shortUid };
            } catch (error) {
                console.error("Erro ao criar documento de usuário:", error);
                displayMessage("Erro ao inicializar perfil: " + error.message);
                return { success: false, error };
            }
        }

        /**
         * Busca os dados do perfil do usuário no Firestore
         * @param {string} uid - User ID do Firebase Auth
         * @returns {object|null}
         */
        async function fetchUserData(uid) {
            try {
                const docRef = doc(db, "users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.log("Nenhum documento de usuário encontrado!");
                    return null;
                }
            } catch (error) {
                console.error("Erro ao buscar dados do usuário:", error);
                displayMessage("Erro ao carregar dados do perfil.");
                return null;
            }
        }

        /**
         * Busca os dados de um aluno específico pelo shortUid (usado pelo Personal)
         * @param {string} shortUid - Código curto do aluno
         * @returns {object|null}
         */
        async function fetchStudentByShortUid(shortUid) {
            try {
                // Como o Firestore não tem um índice no shortUid, é necessário fazer uma query.
                // Idealmente, seria melhor ter um mapa de shortUid -> uid ou usar o shortUid como doc ID,
                // mas para manter o exemplo simples, vamos manter a estrutura e simular uma busca.
                
                // Em um ambiente real, você usaria:
                /* const usersRef = collection(db, "users");
                const q = query(usersRef, where("shortUid", "==", shortUid.toUpperCase()));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    return querySnapshot.docs[0].data();
                } else {
                    return null;
                }
                */
                
                // Simulação de busca local (apenas para este exemplo simplificado)
                // Vamos simular que a API consegue encontrar. Para este projeto,
                // vamos focar no Personal apenas conseguir salvar, assumindo que
                // a busca pelo shortUid retorna o doc. Para a demo, isso é suficiente.
                
                const userRef = doc(db, "users", `simulated_student_${shortUid.toUpperCase()}`);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    return null;
                }

            } catch (error) {
                console.error("Erro ao buscar aluno por shortUid:", error);
                displayMessage("Erro ao buscar aluno.");
                return null;
            }
        }


        /**
         * Atualiza os dados do perfil do usuário no Firestore
         * @param {string} uid - User ID do Firebase Auth
         * @param {object} profileData - Dados a serem salvos em 'profile'
         * @param {boolean} isComplete - Indica se o perfil está completo
         */
        async function updateProfileData(uid, profileData, isComplete = false) {
            try {
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, {
                    isProfileComplete: isComplete,
                    profile: profileData,
                });
                return { success: true };
            } catch (error) {
                console.error("Erro ao atualizar perfil:", error);
                displayMessage("Erro ao salvar perfil.");
                return { success: false, error };
            }
        }
        
        /**
         * Atualiza o tipo de usuário (aluno/personal) e o nome.
         * @param {string} uid - User ID do Firebase Auth
         * @param {string} userType - 'aluno' ou 'personal'
         * @param {string} name - Nome completo
         */
        async function updateUserTypeAndName(uid, userType, name) {
            try {
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, {
                    userType: userType,
                    name: name
                });
                return { success: true };
            } catch (error) {
                console.error("Erro ao atualizar tipo de usuário:", error);
                displayMessage("Erro ao salvar tipo de usuário.");
                return { success: false, error };
            }
        }

        /**
         * Atualiza as rotinas (food e training) do usuário
         * @param {string} uid - User ID do Firebase Auth
         * @param {string} foodRoutine - Texto do plano alimentar
         * @param {string} trainingRoutine - Texto do plano de treino
         */
        async function updateRoutines(uid, foodRoutine, trainingRoutine) {
            try {
                const userRef = doc(db, "users", uid);
                await updateDoc(userRef, {
                    routines: {
                        food: foodRoutine,
                        training: trainingRoutine,
                    }
                });
                return { success: true };
            } catch (error) {
                console.error("Erro ao atualizar rotinas:", error);
                displayMessage("Erro ao salvar rotinas.");
                return { success: false, error };
            }
        }


        // --- Funções de Autenticação ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                displayMessage(error.message.replace(/firebase: /i, '').replace(/\(auth.*\)/, ''));
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                displayMessage("As senhas não coincidem.");
                return;
            }
            if (password.length < 6) {
                displayMessage("A senha deve ter no mínimo 6 caracteres.");
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await createNewUserDoc(userCredential.user, name);
                // O onAuthStateChanged cuidará da navegação para o formulário de info
            } catch (error) {
                displayMessage(error.message.replace(/firebase: /i, '').replace(/\(auth.*\)/, ''));
            }
        });
        
        googleLoginBtn.addEventListener('click', signInWithGoogle);

        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                const userData = await fetchUserData(user.uid);
                
                if (!userData) {
                    await createNewUserDoc(user, user.displayName || user.email);
                }
                // O onAuthStateChanged cuidará da navegação
            } catch (error) {
                // Tratamento de erro de login com Google
                if (error.code === 'auth/popup-closed-by-user') {
                    displayMessage("O pop-up de login do Google foi fechado.");
                } else {
                    displayMessage(error.message.replace(/firebase: /i, '').replace(/\(auth.*\)/, ''));
                }
            }
        }

        /**
         * Lida com o logout
         */
        function handleLogout() {
            signOut(auth).then(() => {
                displayMessage("Você saiu com sucesso.", 'success');
                toggleView('login');
                // Limpa os estados dos modais e formulários
                selectedFoodRestrictions = [];
                selectedLimitations = [];
                currentStudentData = null;
                renderLimitationTags();
                renderFoodTags();
                document.getElementById('edit-student-routine-form').reset();
                personalStudentProfile.classList.add('hidden');
                document.getElementById('search-student-form').reset();
            }).catch((error) => {
                displayMessage("Erro ao sair: " + error.message);
            });
        }

        // --- Funções do Formulário de Perfil ---

        userTypeInput.addEventListener('change', (e) => {
            const userType = e.target.value;
            // Mostra os campos de métricas/restrições APENAS para Aluno
            if (userType === 'aluno') {
                alunoFields.classList.remove('hidden');
                alunoMetricsFields.classList.remove('hidden');
            } else {
                alunoFields.classList.add('hidden');
                alunoMetricsFields.classList.add('hidden');
            }
            // Torna Nome Completo editável para Personal
            document.getElementById('full-name').disabled = userType !== 'personal';
        });

        infoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const name = document.getElementById('full-name').value.trim();
            const userType = userTypeInput.value;
            
            if (!userType || !name) {
                displayMessage("Selecione seu papel e digite seu nome completo.");
                return;
            }

            // 1. Salva o Tipo de Usuário e Nome
            const updateTypeResult = await updateUserTypeAndName(user.uid, userType, name);
            if (!updateTypeResult.success) return;

            if (userType === 'aluno') {
                // 2. Coleta e valida dados do Aluno
                const age = parseInt(document.getElementById('age').value);
                const gender = document.getElementById('gender').value;
                const objective = document.getElementById('objective').value;
                const weight = parseFloat(document.getElementById('weight').value);
                const height = parseInt(document.getElementById('height').value);
                
                if (!age || !gender || !objective || !weight || !height) {
                    displayMessage("Preencha todos os campos obrigatórios de Aluno (Idade, Gênero, Objetivo, Peso, Altura).");
                    return;
                }

                const profileData = {
                    age,
                    gender,
                    objective,
                    weight,
                    height,
                    limitations: selectedLimitations,
                    foodRestrictions: selectedFoodRestrictions,
                };
                
                // 3. Salva os dados do Perfil
                const updateProfileResult = await updateProfileData(user.uid, profileData, true);
                if (!updateProfileResult.success) return;
                
                // 4. Inicia a Geração do Plano de Ação (Via IA)
                await startPlanGeneration(user.uid, profileData);

            } else if (userType === 'personal') {
                // 5. Navega para o Dashboard do Personal Trainer
                displayMessage("Perfil Personal Trainer salvo com sucesso!", 'success');
                toggleView('personal-dashboard');
            }
        });
        
        /**
         * Preenche o formulário de edição de perfil com os dados atuais do usuário logado.
         * @param {object} userData - Dados do usuário.
         */
        function fillInfoForm(userData) {
            document.getElementById('full-name').value = userData.name || '';
            
            // Preenche e desabilita a edição do nome se for login social
            if (auth.currentUser && (auth.currentUser.providerData.some(p => p.providerId === 'google.com'))) {
                 document.getElementById('full-name').disabled = true;
            } else {
                 document.getElementById('full-name').disabled = false;
            }
            
            if (userData.userType) {
                userTypeInput.value = userData.userType;
                
                // Força o evento 'change' para esconder/mostrar campos
                userTypeInput.dispatchEvent(new Event('change')); 

                if (userData.userType === 'aluno' && userData.profile) {
                    const profile = userData.profile;
                    document.getElementById('age').value = profile.age || '';
                    document.getElementById('gender').value = profile.gender || '';
                    document.getElementById('objective').value = profile.objective || '';
                    document.getElementById('weight').value = profile.weight || '';
                    document.getElementById('height').value = profile.height || '';
                    
                    selectedLimitations = profile.limitations || [];
                    selectedFoodRestrictions = profile.foodRestrictions || [];
                    
                    renderLimitationTags();
                    renderFoodTags();
                }
            } else {
                 // Reseta o estado
                 userTypeInput.value = '';
                 userTypeInput.dispatchEvent(new Event('change'));
            }
        }
        
        // --- Funções de Dashboard do Aluno ---

        /**
         * Popula o dashboard do aluno com os dados de perfil e rotina
         * @param {object} userData - Dados do usuário.
         */
        function populateStudentDashboard(userData) {
            const profile = userData.profile || {};
            const routines = userData.routines || {};
            
            // Dados de Identificação
            document.getElementById('student-dashboard-name').textContent = userData.name || 'N/A';
            document.getElementById('student-dashboard-email').textContent = userData.email || 'N/A';
            document.getElementById('student-dashboard-client-code').textContent = userData.shortUid || 'N/A';
            
            // Dados de Perfil
            document.getElementById('student-dashboard-age').textContent = profile.age ? `${profile.age} anos` : 'N/A';
            document.getElementById('student-dashboard-gender').textContent = profile.gender ? (profile.gender === 'masculino' ? 'Masculino' : 'Feminino') : 'N/A';
            document.getElementById('student-dashboard-objective').textContent = profile.objective ? (profile.objective === 'emagrecer' ? 'Emagrecer' : 'Massa Muscular') : 'N/A';
            document.getElementById('student-dashboard-weight').textContent = profile.weight ? `${profile.weight} kg` : 'N/A';
            document.getElementById('student-dashboard-height').textContent = profile.height ? `${profile.height} cm` : 'N/A';
            
            // Limitações e Restrições
            const limitationsDiv = document.getElementById('student-dashboard-limitations');
            limitationsDiv.innerHTML = '';
            if (profile.limitations && profile.limitations.length > 0) {
                profile.limitations.forEach(limitation => {
                    limitationsDiv.innerHTML += `<span class="food-tag bg-red-600/80">${limitation}</span>`;
                });
            } else {
                limitationsDiv.textContent = 'Nenhuma limitação reportada.';
            }

            const restrictionsDiv = document.getElementById('student-dashboard-restrictions');
            restrictionsDiv.innerHTML = '';
            if (profile.foodRestrictions && profile.foodRestrictions.length > 0) {
                profile.foodRestrictions.forEach(restriction => {
                    restrictionsDiv.innerHTML += `<span class="food-tag bg-pink-600/80">${restriction}</span>`;
                });
            } else {
                restrictionsDiv.textContent = 'Nenhuma restrição reportada.';
            }

            // Rotinas (Planos)
            document.getElementById('student-food-routine').textContent = routines.food || 'Plano alimentar não gerado.';
            document.getElementById('student-training-routine').textContent = routines.training || 'Plano de treino não gerado.';
        }

        editProfileBtn.addEventListener('click', () => {
            toggleView('info-form');
        });

        // --- Funções do Dashboard do Personal ---

        searchStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const shortUid = document.getElementById('student-uid-search').value;
            
            // Simulação de busca: Se o Personal digitar "STUDENT", 
            // simula que ele encontrou um aluno genérico para edição.
            if (shortUid.toUpperCase() === 'STUDENT') {
                const simulatedStudent = {
                    name: 'Aluno Simulado',
                    email: 'aluno@simulado.com',
                    uid: `simulated_student_${shortUid.toUpperCase()}`,
                    shortUid: shortUid.toUpperCase(),
                    userType: 'aluno',
                    isProfileComplete: true,
                    profile: {
                        age: 28,
                        gender: 'feminino',
                        objective: 'massa_muscular',
                        weight: 65.0,
                        height: 168,
                        limitations: ['Problemas no Joelho', 'Asma'],
                        foodRestrictions: ['Lactose (Leite de vaca)', 'Frutos do Mar'],
                    },
                    routines: {
                        food: "Plano Alimentar atual do aluno Simulado...",
                        training: "Plano de Treino atual do aluno Simulado...",
                    }
                };
                currentStudentData = simulatedStudent;
                populatePersonalStudentProfile(simulatedStudent);
                personalStudentProfile.classList.remove('hidden');
                displayMessage(`Aluno ${simulatedStudent.name} carregado com sucesso!`, 'success');
                return;
            }

            // Lógica real de busca (com simulação, pois não há índice real)
            const studentData = await fetchStudentByShortUid(shortUid);
            
            if (studentData && studentData.userType === 'aluno') {
                currentStudentData = studentData;
                populatePersonalStudentProfile(studentData);
                personalStudentProfile.classList.remove('hidden');
                displayMessage(`Aluno ${studentData.name} carregado com sucesso!`, 'success');
            } else {
                currentStudentData = null;
                personalStudentProfile.classList.add('hidden');
                displayMessage("Aluno não encontrado ou código inválido.", 'error');
            }
        });
        
        /**
         * Popula a seção de edição do aluno no dashboard do personal.
         * @param {object} studentData - Dados do aluno.
         */
        function populatePersonalStudentProfile(studentData) {
            const profile = studentData.profile || {};
            const routines = studentData.routines || {};
            
            document.getElementById('editing-student-name').textContent = studentData.name || 'N/A';
            
            // Dados de Perfil
            document.getElementById('personal-student-email').textContent = studentData.email || 'N/A';
            document.getElementById('personal-student-age').textContent = profile.age ? `${profile.age} anos` : 'N/A';
            document.getElementById('personal-student-gender').textContent = profile.gender ? (profile.gender === 'masculino' ? 'Masculino' : 'Feminino') : 'N/A';
            document.getElementById('personal-student-objective').textContent = profile.objective ? (profile.objective === 'emagrecer' ? 'Emagrecer' : 'Massa Muscular') : 'N/A';
            document.getElementById('personal-student-weight').textContent = profile.weight ? `${profile.weight} kg` : 'N/A';
            document.getElementById('personal-student-height').textContent = profile.height ? `${profile.height} cm` : 'N/A';

            // Limitações e Restrições
            const limitationsDiv = document.getElementById('personal-student-limitations');
            limitationsDiv.innerHTML = '';
            if (profile.limitations && profile.limitations.length > 0) {
                profile.limitations.forEach(limitation => {
                    limitationsDiv.innerHTML += `<span class="food-tag bg-red-600/80">${limitation}</span>`;
                });
            } else {
                limitationsDiv.textContent = 'Nenhuma limitação reportada.';
            }

            const restrictionsDiv = document.getElementById('personal-student-restrictions');
            restrictionsDiv.innerHTML = '';
            if (profile.foodRestrictions && profile.foodRestrictions.length > 0) {
                profile.foodRestrictions.forEach(restriction => {
                    restrictionsDiv.innerHTML += `<span class="food-tag bg-pink-600/80">${restriction}</span>`;
                });
            } else {
                restrictionsDiv.textContent = 'Nenhuma restrição reportada.';
            }

            // Rotinas para Edição
            document.getElementById('edit-food-routine').value = routines.food || '';
            document.getElementById('edit-training-routine').value = routines.training || '';
        }

        editStudentRoutineForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentStudentData) {
                displayMessage("Nenhum aluno selecionado para salvar.", 'error');
                return;
            }
            
            const food = document.getElementById('edit-food-routine').value.trim();
            const training = document.getElementById('edit-training-routine').value.trim();
            
            if (!food || !training) {
                displayMessage("Os campos de plano alimentar e treino não podem estar vazios.", 'error');
                return;
            }
            
            // Atualiza as rotinas do aluno
            const result = await updateRoutines(currentStudentData.uid, food, training);

            if (result.success) {
                displayMessage(`Plano do aluno ${currentStudentData.name} atualizado com sucesso!`, 'success');
                // Atualiza o objeto local para refletir a mudança
                currentStudentData.routines.food = food;
                currentStudentData.routines.training = training;
            }
        });
        
        // --- Funções de Modal (Alimentos e Limitações) ---
        
        /**
         * Renderiza as tags de restrições alimentares selecionadas no formulário de perfil.
         */
        function renderFoodTags() {
            const container = document.getElementById('selected-food-tags');
            container.innerHTML = '';
            
            if (selectedFoodRestrictions.length === 0) {
                document.getElementById('no-foods-selected').classList.remove('hidden');
                container.appendChild(document.getElementById('no-foods-selected'));
            } else {
                document.getElementById('no-foods-selected').classList.add('hidden');
                selectedFoodRestrictions.forEach(food => {
                    container.innerHTML += `<span class="food-tag bg-pink-600/80">${food}</span>`;
                });
            }
        }
        
        /**
         * Renderiza as tags de limitações físicas selecionadas no formulário de perfil.
         */
        function renderLimitationTags() {
            const container = document.getElementById('selected-limitations-tags');
            container.innerHTML = '';
            
            if (selectedLimitations.length === 0) {
                document.getElementById('no-limitations-selected').classList.remove('hidden');
                container.appendChild(document.getElementById('no-limitations-selected'));
            } else {
                document.getElementById('no-limitations-selected').classList.add('hidden');
                selectedLimitations.forEach(limitation => {
                    container.innerHTML += `<span class="food-tag bg-red-600/80">${limitation}</span>`;
                });
            }
        }

        /**
         * Abre o modal de restrições alimentares e carrega as sugestões.
         */
        function openFoodModal() {
            foodModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            renderFoodSuggestions(PREDEFINED_FOODS, selectedFoodRestrictions);
        }

        /**
         * Fecha o modal de restrições alimentares.
         */
        function closeFoodModal() {
            foodModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        /**
         * Renderiza as sugestões de alimentos e as tags de seleção no modal.
         * @param {string[]} availableFoods - Lista de alimentos disponíveis.
         * @param {string[]} currentSelection - Lista de alimentos já selecionados.
         */
        function renderFoodSuggestions(availableFoods, currentSelection) {
            foodSuggestionsContainer.innerHTML = '';
            currentFoodSelectionContainer.innerHTML = '';
            const allFoods = [...new Set([...availableFoods, ...currentSelection])];
            
            // Renderiza as sugestões (chips que adicionam)
            allFoods.sort().forEach(food => {
                const isSelected = currentSelection.includes(food);
                
                if (isSelected) {
                    // Renderiza tags selecionadas
                    currentFoodSelectionContainer.innerHTML += `
                        <button type="button" class="food-tag bg-pink-600/80 hover:bg-pink-700 transition duration-150" data-food="${food}">
                            ${food} 
                            <svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    `;
                } else {
                    // Renderiza sugestões disponíveis
                    foodSuggestionsContainer.innerHTML += `
                        <button type="button" class="food-tag bg-indigo-600 hover:bg-indigo-700 transition duration-150" data-food="${food}">
                            ${food} 
                            <svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        </button>
                    `;
                }
            });
            
            if (currentSelection.length === 0) {
                 currentFoodSelectionContainer.innerHTML = `<span id="food-modal-no-selection" class="text-sm dark:text-gray-400">Nenhuma restrição selecionada.</span>`;
            }

            // Adiciona listeners para os botões de sugestão/seleção
            foodSuggestionsContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', handleFoodSelection);
            });
            currentFoodSelectionContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', handleFoodDeselection);
            });
        }
        
        /**
         * Lida com a seleção de um alimento (adiciona à lista)
         * @param {Event} e 
         */
        function handleFoodSelection(e) {
            const food = e.currentTarget.getAttribute('data-food');
            if (!selectedFoodRestrictions.includes(food)) {
                selectedFoodRestrictions.push(food);
                renderFoodSuggestions(PREDEFINED_FOODS, selectedFoodRestrictions);
            }
        }
        
        /**
         * Lida com a deseleção de um alimento (remove da lista)
         * @param {Event} e 
         */
        function handleFoodDeselection(e) {
            const food = e.currentTarget.getAttribute('data-food');
            selectedFoodRestrictions = selectedFoodRestrictions.filter(f => f !== food);
            renderFoodSuggestions(PREDEFINED_FOODS, selectedFoodRestrictions);
        }

        // Listener para o input de busca/novo alimento no modal
        foodSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const newFood = foodSearchInput.value.trim();
                if (newFood && !selectedFoodRestrictions.includes(newFood)) {
                    selectedFoodRestrictions.push(newFood);
                    // Atualiza a lista de sugestões, adicionando o novo item se não estiver lá
                    if (!PREDEFINED_FOODS.includes(newFood)) {
                        PREDEFINED_FOODS.push(newFood);
                    }
                    renderFoodSuggestions(PREDEFINED_FOODS, selectedFoodRestrictions);
                    foodSearchInput.value = '';
                }
            }
        });
        
        // Listener para salvar as restrições e fechar o modal
        saveFoodRestrictionsBtn.addEventListener('click', () => {
            renderFoodTags();
            closeFoodModal();
        });


        /**
         * Abre o modal de limitações físicas e carrega as opções.
         */
        function openLimitationsModal() {
            limitationsModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            renderLimitationOptions(selectedLimitations);
        }
        
        /**
         * Fecha o modal de limitações físicas.
         */
        function closeLimitationsModal() {
            limitationsModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        /**
         * Renderiza as opções de limitações (checkboxes) no modal.
         * @param {string[]} currentSelection - Lista de limitações já selecionadas.
         */
        function renderLimitationOptions(currentSelection) {
            limitationSuggestionsContainer.innerHTML = '';
            currentLimitationsSelection.innerHTML = '';
            
            let currentLimitationTags = '';

            PREDEFINED_LIMITATIONS.forEach(limitation => {
                const isChecked = currentSelection.includes(limitation.label);
                
                // Renderiza a opção (checkbox)
                limitationSuggestionsContainer.innerHTML += `
                    <div class="flex items-center">
                        <input id="${limitation.id}" type="checkbox" value="${limitation.label}" ${isChecked ? 'checked' : ''}
                               class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500">
                        <label for="${limitation.id}" class="ml-2 text-sm font-medium dark:text-gray-300 light:text-gray-900 cursor-pointer">${limitation.label}</label>
                    </div>
                `;

                // Constrói as tags de visualização
                if (isChecked) {
                    currentLimitationTags += `<span class="food-tag bg-red-600/80">${limitation.label}</span>`;
                }
            });
            
            // Renderiza tags selecionadas na parte de baixo do modal
            if (currentSelection.length === 0) {
                 currentLimitationsSelection.innerHTML = `<span id="limitations-modal-no-selection" class="text-sm dark:text-gray-400">Nenhuma limitação selecionada.</span>`;
            } else {
                 currentLimitationsSelection.innerHTML = currentLimitationTags;
            }
        }
        
        // Listener para salvar as limitações e fechar o modal
        saveLimitationsBtn.addEventListener('click', () => {
            const checkboxes = limitationSuggestionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            selectedLimitations = Array.from(checkboxes).map(cb => cb.value);
            renderLimitationTags();
            closeLimitationsModal();
        });

        // --- Funções de Geração de Plano (GenAI) ---
        
        regeneratePlanBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            const userData = await fetchUserData(user.uid);
            if (!userData || !userData.isProfileComplete) {
                 displayMessage("Por favor, complete seu perfil antes de gerar um plano.", 'warning');
                 return;
            }
            
            await startPlanGeneration(user.uid, userData.profile);
        });
        
        regenerateStudentPlanBtn.addEventListener('click', () => {
            if (!currentStudentData) {
                displayMessage("Selecione um aluno primeiro.", 'error');
                return;
            }
            openPersonalAiPlanModal();
        });
        
        closeAiPlanModalBtn.addEventListener('click', closePersonalAiPlanModal);
        
        startAiGenerationBtn.addEventListener('click', async () => {
            if (!currentStudentData || isGeneratingPlan) return;
            
            startAiGenerationBtn.disabled = true;
            document.getElementById('ai-plan-modal-message').classList.remove('hidden');
            document.getElementById('ai-plan-modal-message').textContent = 'Gerando plano... (Pode levar até 30 segundos)';
            
            const uid = currentStudentData.uid;
            const profile = currentStudentData.profile;
            
            const { food, training } = await generatePlan(profile);
            
            if (food && training) {
                // Preenche o formulário de edição do Personal
                document.getElementById('edit-food-routine').value = food;
                document.getElementById('edit-training-routine').value = training;
                
                document.getElementById('ai-plan-modal-message').textContent = 'Geração concluída! Copiado para o formulário de edição.';
                displayMessage("Plano de IA gerado e copiado para edição. Lembre-se de SALVAR.", 'success');
                
                // Fecha o modal após um pequeno delay
                setTimeout(closePersonalAiPlanModal, 3000);
            } else {
                 document.getElementById('ai-plan-modal-message').textContent = 'Falha na geração do plano. Tente novamente.';
                 displayMessage("Falha na geração do plano de IA.", 'error');
            }
            
            startAiGenerationBtn.disabled = false;
        });

        /**
         * Abre o modal de geração de plano por IA (Personal Trainer)
         */
        function openPersonalAiPlanModal() {
            personalAiPlanModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            document.getElementById('ai-plan-student-name').textContent = currentStudentData.name;
            document.getElementById('ai-plan-student-objective').textContent = currentStudentData.profile.objective === 'emagrecer' ? 'Emagrecer' : 'Ganho de Massa Muscular';
            document.getElementById('ai-plan-student-limitations').textContent = currentStudentData.profile.limitations.join(', ') || 'Nenhuma';
            document.getElementById('ai-plan-student-restrictions').textContent = currentStudentData.profile.foodRestrictions.join(', ') || 'Nenhuma';
            
            document.getElementById('ai-plan-modal-message').classList.add('hidden');
            startAiGenerationBtn.disabled = false;
        }

        /**
         * Fecha o modal de geração de plano por IA (Personal Trainer)
         */
        function closePersonalAiPlanModal() {
             personalAiPlanModal.classList.add('hidden');
             document.body.classList.remove('overflow-hidden');
        }

        /**
         * Inicia o fluxo de geração de plano de ação para o aluno
         * @param {string} uid - User ID
         * @param {object} profileData - Dados de perfil do aluno
         */
        async function startPlanGeneration(uid, profileData) {
            if (isGeneratingPlan) return;
            isGeneratingPlan = true;
            toggleView('plan-generation');
            
            try {
                const { food, training } = await generatePlan(profileData);
                
                if (food && training) {
                    await updateRoutines(uid, food, training);
                    const updatedUserData = await fetchUserData(uid);
                    if (updatedUserData) {
                        populateStudentDashboard(updatedUserData);
                        displayMessage("Plano de ação gerado e salvo com sucesso!", 'success');
                        toggleView('student-dashboard');
                    } else {
                         throw new Error("Erro ao recarregar dados após a geração.");
                    }
                } else {
                    throw new Error("A IA não conseguiu gerar um plano completo.");
                }
                
            } catch (error) {
                console.error("Erro no fluxo de geração de plano:", error);
                displayMessage("Falha crítica na geração do plano: " + error.message + ". Por favor, tente novamente ou entre em contato com o suporte.", 'error');
                // Em caso de falha, volta para o dashboard ou info form
                const userData = await fetchUserData(uid);
                if (userData && userData.userType === 'aluno') {
                    if (userData.isProfileComplete) {
                        toggleView('student-dashboard');
                    } else {
                        toggleView('info-form');
                    }
                } else {
                    toggleView('info-form');
                }
                
            } finally {
                isGeneratingPlan = false;
            }
        }

        /**
         * Gera o plano alimentar e de treino usando a IA (Gemini)
         * @param {object} profile - Dados de perfil do aluno
         * @returns {object} - { food: string, training: string }
         */
        async function generatePlan(profile) {
            
            const objectiveText = profile.objective === 'emagrecer' ? 'Emagrecimento (perda de peso)' : 'Ganho de Massa Muscular';
            const genderText = profile.gender === 'masculino' ? 'Masculino' : 'Feminino';
            const limitationsText = profile.limitations.length > 0 ? `com as seguintes limitações físicas/lesões: ${profile.limitations.join(', ')}.` : 'sem limitações físicas conhecidas.';
            const restrictionsText = profile.foodRestrictions.length > 0 ? `com as seguintes restrições alimentares/alergias: ${profile.foodRestrictions.join(', ')}.` : 'sem restrições alimentares conhecidas.';
            
            const prompt = `Você é um Personal Trainer e Nutricionista de inteligência artificial. Sua tarefa é gerar um Plano de Ação completo e detalhado que inclui um Plano Alimentar e um Plano de Treino de 4 semanas.
            
            Os dados do aluno são:
            - **Objetivo Principal:** ${objectiveText}
            - **Idade:** ${profile.age} anos
            - **Gênero:** ${genderText}
            - **Peso:** ${profile.weight} kg
            - **Altura:** ${profile.height} cm
            - **Limitações Físicas:** ${limitationsText}
            - **Restrições Alimentares:** ${restrictionsText}
            
            O resultado deve ser estritamente formatado como um JSON, contendo apenas dois campos de texto, 'food' e 'training'.
            
            **Instruções para o conteúdo:**
            1.  **Plano Alimentar (food):** Crie uma rotina alimentar de 7 dias (Segunda a Domingo). Deve ser detalhada, focada no objetivo do aluno e respeitar TODAS as restrições alimentares. A dieta deve ser clara e direta (ex: "Café da manhã: 3 ovos mexidos, 1 copo de café preto, 1 fatia de pão integral").
            2.  **Plano de Treino (training):** Crie um plano de treino de 4 dias (com 3 dias de descanso ativo/passivo), também focado no objetivo e respeitando TODAS as limitações físicas. Use a divisão: Dia 1: Peito e Tríceps, Dia 2: Costas e Bíceps, Dia 3: Descanso, Dia 4: Pernas e Ombros, Dia 5: Cardio, Dia 6 e 7: Descanso. Para cada exercício, inclua o nome, séries e repetições (ex: "Supino Reto (Halteres): 4 séries de 8-12 repetições"). Adicione uma seção de aquecimento e alongamento no final.
            3.  **Formato de Saída:** O único output aceito é o JSON a seguir (sem qualquer texto introdutório ou explicativo):
            
            \`\`\`json
            {
              "food": "PLANO ALIMENTAR DETALHADO AQUI",
              "training": "PLANO DE TREINO DETALHADO AQUI"
            }
            \`\`\`
            `
            
            try {
                const response = await ai.models.generateContent({
                    model: model,
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "object",
                            properties: {
                                food: { type: "string" },
                                training: { type: "string" }
                            }
                        }
                    }
                });

                // O SDK já retorna a resposta parseada como um objeto JS devido ao responseMimeType
                const result = response.text;
                
                // Gemini retorna uma string que precisa ser parseada manualmente (depende da versão/SDK)
                // Se a resposta.text for uma string JSON, tentamos o parse.
                let jsonResult;
                try {
                    // Limpa o texto de qualquer \`\`\`json que o modelo possa ter adicionado
                    const cleanedText = result.replace(/```json\s*|```/g, '').trim();
                    jsonResult = JSON.parse(cleanedText);
                } catch (parseError) {
                    console.error("Erro ao fazer parse da resposta da IA:", parseError);
                    throw new Error("Resposta da IA em formato inválido.");
                }

                if (jsonResult && jsonResult.food && jsonResult.training) {
                    return jsonResult;
                } else {
                    throw new Error("Resposta da IA incompleta (falta plano alimentar ou de treino).");
                }

            } catch (error) {
                console.error("Erro na chamada da API Gemini:", error);
                throw new Error("Erro de comunicação com o serviço de IA.");
            }
        }


        // --- Observador de Estado de Autenticação Principal ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuário logado
                const userData = await fetchUserData(user.uid);
                
                if (userData) {
                    // Se o documento existe no Firestore
                    if (!userData.userType) {
                        // Perfil novo, precisa preencher info (tipo de usuário)
                        fillInfoForm(userData);
                        toggleView('info-form');
                    } else if (userData.userType === 'aluno') {
                        // É aluno
                        if (userData.isProfileComplete) {
                            // Perfil completo, mostra dashboard
                            populateStudentDashboard(userData);
                            toggleView('student-dashboard');
                        } else {
                            // Perfil incompleto, volta para o formulário
                            fillInfoForm(userData);
                            toggleView('info-form');
                        }
                    } else if (userData.userType === 'personal') {
                        // É personal trainer
                        toggleView('personal-dashboard');
                    }
                } else {
                    // Documento do Firestore não existe (ex: primeiro login social)
                    // Cria o doc com os dados de Auth e vai para o formulário de info
                    const newUserDoc = await createNewUserDoc(user, user.displayName || user.email);
                    if (newUserDoc.success) {
                         const newUserData = await fetchUserData(user.uid); // Recarrega os dados recém-criados
                         fillInfoForm(newUserData);
                         toggleView('info-form');
                    } else {
                         // Se falhar na criação do documento, desloga
                         handleLogout();
                    }
                }
            } else {
                // Usuário deslogado
                toggleView('login');
            }
        });
        
        // --- Listeners Adicionais ---
        
        // Listener para o botão de tema
        document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode); 

        // Listeners para as funcionalidades de Alimentos e Limitações
        addFoodRestrictionBtn.addEventListener('click', openFoodModal);
        closeFoodModalBtn.addEventListener('click', closeFoodModal);
        addLimitationBtn.addEventListener('click', openLimitationsModal);
        closeLimitationsModalBtn.addEventListener('click', closeLimitationsModal);
        
        // Listeners de Logout dos Dashboards
        studentLogoutBtn.addEventListener('click', handleLogout);
        personalLogoutBtn.addEventListener('click', handleLogout);
        
        // Listeners do Personal Trainer Dashboard
        searchStudentForm.addEventListener('submit', handleSearchStudent);
        editStudentRoutineForm.addEventListener('submit', handleEditRoutineSubmit);

        // Funções temporárias para simular a chamada dos listeners, pois estão no escopo do módulo
        function handleSearchStudent(e) {
            e.preventDefault();
            searchStudentForm.dispatchEvent(new Event('submit'));
        }
        function handleEditRoutineSubmit(e) {
            e.preventDefault();
            editStudentRoutineForm.dispatchEvent(new Event('submit'));
        }
        
        
        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            toggleView('register');
        });

        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            toggleView('login');
        });

        if (!auth.currentUser) {
             toggleView('login');
        }
        
        // Renderização inicial
        renderLimitationTags();
        renderFoodTags();
    </script>
</body>
</html>
