<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Trainer IA com Firebase (Simulado)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilização para Placeholders no Dark Mode Padrão (Melhor legibilidade) */
        input::placeholder {
            color: #9ca3af; /* gray-400 */
            opacity: 1; 
        }
        /* Ajuste do Select no Dark Mode: garante que o texto seja claro */
        select {
            color: white; 
        }
        /* Ajuste do Select no Light Mode: garante que o texto seja escuro */
        .light select {
            color: #4b5563; /* gray-700 */
        }
        /* Estilo para tags (chips) */
        .food-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px; /* rounded-full */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        /* Remove a barra de rolagem dos textareas, se houver, garantindo que o body role. */
        textarea {
            overflow: hidden; /* Oculta a barra de rolagem padrão se não for necessário */
            resize: vertical; /* Permite redimensionar apenas verticalmente */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 transition-colors duration-300 bg-gray-900"> 

    <div id="auth-card" class="mx-auto w-full p-8 sm:p-10 rounded-xl shadow-2xl transition-all duration-300 dark:shadow-none border border-gray-700 bg-gray-800 text-gray-200 max-w-md">
        
        <div class="flex justify-end mb-4">
            <button id="theme-toggle" class="p-2 rounded-full text-gray-300 hover:text-indigo-400 transition duration-300">
                <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moon-icon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>

        <div id="message-area" class="mb-4 hidden p-3 rounded-lg text-sm transition-opacity duration-300" role="alert"></div>

        <div id="login-view" class="view">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Acesse sua Conta</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">E-mail</label>
                    <input type="email" id="login-email" placeholder="seu@email.com" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Senha</label>
                    <input type="password" id="login-password" placeholder="••••••••" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                
                <button type="submit"
                         class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md">
                    Entrar
                </button>
            </form>

            <div class="my-6 flex items-center">
                <div class="flex-grow border-t border-gray-700 light:border-gray-300"></div>
                <span class="flex-shrink mx-4 text-sm dark:text-gray-400 light:text-gray-500">OU</span>
                <div class="flex-grow border-t border-gray-700 light:border-gray-300"></div>
            </div>

            <button id="google-login-btn"
                     class="w-full flex items-center justify-center py-2 px-4 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg shadow-sm text-sm font-medium dark:text-gray-200 light:text-gray-700 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 hover:bg-gray-600 light:hover:bg-gray-200 transition duration-150">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48">
                    <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.158,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.684,43.868,21.327,43.611,20.083z"/>
                    <path fill="#FF3D00" d="M6.306 14.691L11.41 18.257C13.204 16.292 14.004 14.072 14.004 12C14.004 9.928 13.204 7.708 11.41 5.743L6.306 9.309C5.541 10.334 5.148 11.167 5.148 12C5.148 12.833 5.541 13.666 6.306 14.691z"/>
                    <path fill="#4CAF50" d="M24 44C12.955 44 4 35.045 4 24C4 22.684 4.132 21.327 4.389 20.083H1.944C1.353 21.378 1 22.673 1 24C1 37.807 12.193 49 26 49C29.626 49 33.024 48.219 35.91 46.853L30.253 42.275C28.483 43.141 26.242 43.5 24 43.5z"/>
                    <path fill="#1976D2" d="M43.611 20.083C43.868 21.327 44 22.684 44 24C44 25.316 43.868 26.673 43.611 27.917L42 27.917L30.253 32.535C30.253 32.535 30.253 32.535 30.253 32.535L35.91 37.113C38.796 35.747 41.677 32.866 43.611 27.917z"/>
                </svg>
                Entrar com Google
            </button>

            <p class="mt-6 text-center text-sm dark:text-gray-400 light:text-gray-600">
                Não tem uma conta?
                <a href="#" id="show-register-link" class="font-medium text-indigo-400 hover:text-indigo-300 dark:text-indigo-400 light:text-indigo-600">
                    Criar conta
                </a>
            </p>
        </div>

        <div id="register-view" class="view hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Crie sua Conta</h2>
            <form id="register-form" class="space-y-4">
                <div>
                    <label for="register-name" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Nome Completo</label>
                    <input type="text" id="register-name" placeholder="Seu Nome" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-email" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">E-mail</label>
                    <input type="email" id="register-email" placeholder="seu@email.com" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Senha</label>
                    <input type="password" id="register-password" placeholder="Mínimo 6 caracteres" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                <div>
                    <label for="register-confirm-password" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Confirme a Senha</label>
                    <input type="password" id="register-confirm-password" placeholder="Repita a senha" required
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>
                
                <button type="submit"
                         class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition duration-150 shadow-md">
                    Criar Conta
                </button>
            </form>

            <p class="mt-6 text-center text-sm dark:text-gray-400 light:text-gray-600">
                Já tem uma conta?
                <a href="#" id="show-login-link" class="font-medium text-indigo-400 hover:text-indigo-300 dark:text-indigo-400 light:text-indigo-600">
                    Fazer Login
                </a>
            </p>
        </div>
        
        <div id="info-form-view" class="view hidden">
            <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-6 text-center">Seu Perfil</h2>
            <p class="text-center dark:text-gray-400 light:text-gray-500 mb-6">Preencha ou atualize seus dados.</p>
            
            <form id="info-form" class="space-y-4">

                <div>
                    <label for="user-type-input" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Tipo de Usuário</label>
                    <select id="user-type-input" required
                             class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                        <option value="" disabled selected>Selecione seu papel (Aluno ou Personal)</option>
                        <option value="aluno">Aluno</option>
                        <option value="personal">Personal Trainer</option>
                    </select>
                </div>
                
                <div>
                    <label for="full-name" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Nome Completo</label>
                    <input type="text" id="full-name" placeholder="Nome Completo" 
                           class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                </div>

                <div id="aluno-metrics-fields" class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="age" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Idade</label>
                        <input type="number" id="age" placeholder="Ex: 30" min="1" max="150" required
                               class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>

                    <div>
                        <label for="gender" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Gênero</label>
                        <select id="gender" required
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                            <option value="" disabled selected>Selecione</option>
                            <option value="masculino">Masculino</option>
                            <option value="feminino">Feminino</option>
                        </select>
                    </div>
                    
                    <div id="objective-field-container">
                        <label for="objective" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Objetivo</label>
                        <select id="objective" required
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900 appearance-none pr-8">
                            <option value="" disabled selected>Selecione seu objetivo principal</option>
                            <option value="emagrecer">Emagrecer</option>
                            <option value="massa_muscular">Obter Massa Muscular</option>
                        </select>
                    </div>

                    <div class="hidden">
                        </div>

                    <div>
                        <label for="weight" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Peso (kg)</label>
                        <input type="number" id="weight" placeholder="Ex: 75.5" step="0.1" min="1" 
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>

                    <div>
                        <label for="height" class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Altura (cm)</label>
                        <input type="number" id="height" placeholder="Ex: 175" step="1" min="50" 
                                 class="w-full px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-gray-100 text-white dark:text-white light:text-gray-900">
                    </div>
                </div>

                <div id="aluno-fields" class="space-y-4 hidden pt-2 border-t border-dashed border-gray-600/50 light:border-gray-300/50">
                    <p class="text-sm dark:text-gray-400 light:text-gray-700 font-semibold pt-2">Informações Adicionais (Aluno)</p>

                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Limitações Físicas (Selecione uma ou mais)</label>
                        <div id="selected-limitations-tags" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus-within:border-indigo-500 transition duration-150 bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100/50">
                            <span id="no-limitations-selected" class="text-sm dark:text-gray-400 light:text-gray-500">Nenhuma limitação selecionada.</span>
                        </div>
                        
                        <button type="button" id="add-limitation-btn"
                                class="mt-2 w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition duration-150 flex items-center justify-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Adicionar/Editar Limitações
                        </button>
                        <p class="text-xs dark:text-gray-500 light:text-gray-500 mt-1">Clique acima para selecionar as limitações aplicáveis.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-200 light:text-gray-900">Alimentos que Não Gosta/Não Pode Comer</label>
                        <div id="selected-food-tags" class="flex flex-wrap gap-2 p-2 min-h-[40px] border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus-within:border-indigo-500 transition duration-150 bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100/50">
                            <span id="no-foods-selected" class="text-sm dark:text-gray-400 light:text-gray-500">Nenhum alimento selecionado.</span>
                        </div>
                        
                        <button type="button" id="add-food-restriction-btn"
                                class="mt-2 w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-500 hover:bg-indigo-600 transition duration-150 flex items-center justify-center text-sm">
                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            Adicionar/Editar Alimentos
                        </button>
                        <p class="text-xs dark:text-gray-500 light:text-gray-500 mt-1">Clique acima para selecionar múltiplos alimentos.</p>
                    </div>
                </div>

                <button type="submit" id="save-info-btn"
                         class="w-full py-2 px-4 mt-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 shadow-md">
                    Salvar Informações
                </button>
            </form>
        </div>

        <div id="plan-generation-view" class="view hidden text-center p-8">
            <svg class="mx-auto h-16 w-16 text-indigo-500 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mt-4" id="generation-message-title">Gerando Plano de Ação...</h2>
            <p class="mt-2 dark:text-gray-400 light:text-gray-600" id="generation-message-text">Estamos criando sua rotina alimentar e de treino, baseada em seus dados e restrições. Isso levará apenas alguns segundos.</p>
        </div>

        <div id="student-dashboard-view" class="view hidden w-full max-w-4xl mx-auto p-4 sm:p-8 bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl shadow-2xl dark:shadow-none border border-gray-700 dark:border-gray-700 light:border-gray-300">
            <header class="flex justify-between items-center mb-6 border-b pb-4 border-gray-700 dark:border-gray-700 light:border-gray-200">
                <h1 class="text-3xl font-extrabold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">Dashboard do Aluno</h1>
                <button id="student-logout-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition duration-150 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sair
                </button>
            </header>

            <section id="student-info-section" class="mb-8">
                <h2 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900">Bem-vindo(a), <span id="student-dashboard-name" class="text-indigo-400"></span>!</h2>
                
                <div class="bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-600 dark:border-gray-600 light:border-gray-300">
                    <h3 class="text-xl font-semibold mb-4 dark:text-white light:text-gray-800">Seus Dados de Perfil</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2 gap-x-4 dark:text-gray-200 light:text-gray-700">
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">E-mail:</span> <span id="student-dashboard-email" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Idade:</span> <span id="student-dashboard-age" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Objetivo:</span> <span id="student-dashboard-objective" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Gênero:</span> <span id="student-dashboard-gender" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Peso:</span> <span id="student-dashboard-weight" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Altura:</span> <span id="student-dashboard-height" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                        <p><span class="font-medium text-gray-500 dark:text-gray-300">Meta Calórica:</span> <span id="student-dashboard-calorie-goal" class="text-gray-900 dark:text-white block sm:inline"></span></p>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-600 dark:border-gray-600 light:border-gray-300">
                        <p class="font-medium text-gray-500 dark:text-gray-300 mb-2">Restrições Alimentares:</p>
                        <div id="student-dashboard-food-restrictions" class="flex flex-wrap gap-2 min-h-[20px]">
                            <span class="dark:text-gray-400 light:text-gray-500">Nenhuma.</span>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-600 dark:border-gray-600 light:border-gray-300">
                        <p class="font-medium text-gray-500 dark:text-gray-300 mb-2">Limitações Físicas:</p>
                        <div id="student-dashboard-limitations" class="flex flex-wrap gap-2 min-h-[20px]">
                            <span class="dark:text-gray-400 light:text-gray-500">Nenhuma.</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="student-routine-section" class="space-y-8">
                
                <h2 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900">Sua Rotina</h2>

                <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-pink-500/50">
                    <h3 class="text-3xl font-bold mb-4 dark:text-pink-400 light:text-pink-900 flex items-center border-b border-gray-300 dark:border-gray-600 pb-2">
                        <svg class="w-7 h-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-8v8m-4-8v8m6-12h-6a2 2 0 00-2 2v12a2 2 0 002 2h6a2 2 0 002-2V6a2 2 0 00-2-2z" />
                        </svg>
                        Plano Alimentar
                    </h3>
                    <p class="text-lg font-bold mb-4 dark:text-pink-300 light:text-pink-800">
                        Total de Calorias Estimado na Rotina: <span id="student-food-routine-calories" class="text-xl font-extrabold dark:text-white light:text-gray-900">Aguardando geração...</span>
                    </p>
                    <pre id="student-food-routine" class="whitespace-pre-wrap font-mono text-sm dark:text-gray-300 light:text-gray-800 bg-gray-600/50 dark:bg-gray-600/50 light:bg-gray-200 p-4 rounded-lg overflow-x-auto"></pre>
                    <button id="generate-plan-btn" class="mt-4 py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150 w-full flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Gerar Plano de Ação (Alimentar e Treino)
                    </button>
                    <p id="plan-status" class="mt-2 text-center text-sm dark:text-yellow-400 light:text-yellow-700 hidden"></p>
                </div>

                <div class="bg-gray-50 dark:bg-gray-700/70 p-6 rounded-xl shadow-xl dark:shadow-none border border-gray-200 dark:border-green-500/50">
                    <h3 class="text-3xl font-bold mb-4 dark:text-green-400 light:text-green-800 flex items-center border-b border-gray-300 dark:border-gray-600 pb-2">
                        <svg class="w-7 h-7 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M11 20H4a2 2 0 01-2-2V6a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2h-4M10 9l-3 3 3 3" />
                        </svg>
                        Plano de Treino
                    </h3>
                    <pre id="student-training-routine" class="whitespace-pre-wrap font-mono text-sm dark:text-gray-300 light:text-gray-800 bg-gray-600/50 dark:bg-gray-600/50 light:bg-gray-200 p-4 rounded-lg overflow-x-auto"></pre>
                </div>

            </section>
        </div>

        <div id="personal-dashboard-view" class="view hidden w-full max-w-4xl mx-auto p-4 sm:p-8 bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl shadow-2xl dark:shadow-none border border-gray-700 dark:border-gray-700 light:border-gray-300">
            <header class="flex justify-between items-center mb-6 border-b pb-4 border-gray-700 dark:border-gray-700 light:border-gray-200">
                <h1 class="text-3xl font-extrabold text-pink-400 dark:text-pink-400 light:text-pink-600">Dashboard do Personal</h1>
                <button id="personal-logout-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition duration-150 flex items-center text-sm">
                    <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sair
                </button>
            </header>

            <section id="personal-welcome-section" class="mb-8">
                <h2 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900">Olá, <span id="personal-dashboard-name" class="text-pink-400"></span>!</h2>
                <p class="dark:text-gray-300 light:text-gray-700">Utilize o campo abaixo para buscar e gerenciar os planos de seus alunos.</p>
            </section>

            <section id="search-student-section" class="mb-8 p-6 bg-gray-700/50 dark:bg-gray-700/50 light:bg-gray-100 rounded-xl shadow-lg border border-gray-600 dark:border-gray-600 light:border-gray-300">
                <h3 class="text-xl font-semibold mb-4 dark:text-white light:text-gray-800">Buscar Aluno por ID</h3>
                <form id="search-student-form" class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="student-id-input" placeholder="ID do Aluno (ex: 1234)" required
                           class="flex-grow px-4 py-2 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-white text-white dark:text-white light:text-gray-900">
                    <button type="submit"
                             class="py-2 px-6 rounded-lg text-white font-semibold bg-pink-600 hover:bg-pink-700 transition duration-150 shadow-md">
                        Buscar
                    </button>
                </form>
                <p id="search-message" class="mt-3 text-sm dark:text-red-400 light:text-red-600 hidden"></p>
            </section>

            <section id="edit-routine-section" class="hidden">
                <h3 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900 border-b pb-2">Gerenciar: <span id="searched-student-name" class="text-pink-400"></span></h3>

                <div class="dark:text-gray-300 light:text-gray-700 mb-6">
                    <p class="mb-2"><span class="font-medium dark:text-gray-400 light:text-gray-500">E-mail:</span> <span id="searched-student-email"></span></p>
                    <p class="mb-2"><span class="font-medium dark:text-gray-400 light:text-gray-500">Meta Calórica (Calculada):</span> <span id="searched-student-calorie-goal" class="font-extrabold text-pink-300 dark:text-pink-300"></span></p>
                    <p class="font-medium dark:text-gray-400 light:text-gray-500">Restrições e Limitações: <span id="searched-student-details" class="font-normal"></span></p>
                </div>

                <form id="edit-student-routine-form" class="space-y-6">
                    <div>
                        <label for="edit-food-routine" class="block text-xl font-medium mb-2 dark:text-pink-400 light:text-pink-800">Plano Alimentar</label>
                        <textarea id="edit-food-routine" rows="10" placeholder="Edite o plano alimentar aqui. Lembre-se de manter a frase 'Total de Calorias Estimado na Rotina: X Kcal' no final do plano se quiser atualizar a contagem de calorias."
                                  class="w-full p-4 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-white text-white dark:text-white light:text-gray-900 text-sm font-mono"></textarea>
                    </div>

                    <div>
                        <label for="edit-training-routine" class="block text-xl font-medium mb-2 dark:text-green-400 light:text-green-800">Plano de Treino</label>
                        <textarea id="edit-training-routine" rows="10" placeholder="Edite o plano de treino aqui."
                                  class="w-full p-4 border border-gray-600 dark:border-gray-600 light:border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150 bg-gray-700 dark:bg-gray-700 light:bg-white text-white dark:text-white light:text-gray-900 text-sm font-mono"></textarea>
                    </div>

                    <button type="submit"
                             class="w-full py-3 px-4 rounded-lg text-white font-semibold bg-pink-600 hover:bg-pink-700 transition duration-150 shadow-md">
                        Salvar Alterações
                    </button>
                    <p id="edit-message" class="mt-3 text-center text-sm dark:text-green-400 light:text-green-700 hidden"></p>
                </form>
            </section>
        </div>
    </div>

    <div id="food-restriction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900">Restrições Alimentares</h3>
            <div id="food-restriction-list" class="space-y-2 max-h-80 overflow-y-auto pr-2 mb-4 dark:text-gray-300 light:text-gray-700">
                </div>
            <button id="close-food-modal-btn" class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150">Fechar</button>
        </div>
    </div>

    <div id="limitations-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 dark:bg-gray-800 light:bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-4 dark:text-white light:text-gray-900">Limitações Físicas</h3>
            <div id="limitations-list" class="space-y-2 max-h-80 overflow-y-auto pr-2 mb-4 dark:text-gray-300 light:text-gray-700">
                </div>
            <button id="close-limitations-modal-btn" class="w-full py-2 px-4 rounded-lg text-white font-semibold bg-indigo-600 hover:bg-indigo-700 transition duration-150">Fechar</button>
        </div>
    </div>


    <script type="module">
        // Simulação do SDK do Firebase e Geração de Planos com IA (Gemini)

        // Variáveis de Mocks/Simulação
        const MOCK_DB = {};
        const MOCK_AUTH_STATE = { currentUser: null };

        // --- Simulação de Funções Firebase ---

        const auth = {
            currentUser: null,
            onAuthStateChanged: (callback) => {
                // Simula o estado inicial
                MOCK_AUTH_STATE.currentUser = JSON.parse(localStorage.getItem('currentUser'));
                auth.currentUser = MOCK_AUTH_STATE.currentUser;
                callback(auth.currentUser);
            }
        };

        const db = {
            collection: (name) => ({
                doc: (id) => ({
                    get: async () => {
                        return {
                            exists: !!MOCK_DB[name]?.[id],
                            data: () => MOCK_DB[name]?.[id] || null
                        };
                    },
                    set: async (data, options = {}) => {
                        if (!MOCK_DB[name]) MOCK_DB[name] = {};
                        if (options.merge) {
                            MOCK_DB[name][id] = { ...MOCK_DB[name][id], ...data };
                        } else {
                            MOCK_DB[name][id] = data;
                        }
                        // Persistir no localStorage
                        localStorage.setItem(name, JSON.stringify(MOCK_DB[name]));
                        return true;
                    }
                })
            })
        };

        async function initializeMockDB() {
            MOCK_DB.users = JSON.parse(localStorage.getItem('users')) || {};
            MOCK_DB.studentProfiles = JSON.parse(localStorage.getItem('studentProfiles')) || {};
        }

        async function mockSignIn(email, password) {
            await initializeMockDB();
            const userId = Object.keys(MOCK_DB.users).find(id => MOCK_DB.users[id].email === email && MOCK_DB.users[id].password === password);
            if (userId) {
                const user = MOCK_DB.users[userId];
                MOCK_AUTH_STATE.currentUser = { uid: userId, email: user.email, userType: user.userType };
                auth.currentUser = MOCK_AUTH_STATE.currentUser;
                localStorage.setItem('currentUser', JSON.stringify(auth.currentUser));
                return { user: MOCK_AUTH_STATE.currentUser };
            }
            throw new Error("E-mail ou senha inválidos.");
        }

        async function mockSignUp(email, password, fullName) {
            await initializeMockDB();
            const existingUser = Object.values(MOCK_DB.users).find(user => user.email === email);
            if (existingUser) {
                throw new Error("Este e-mail já está cadastrado.");
            }
            const userId = `user_${Date.now()}`;
            MOCK_DB.users[userId] = { userId, email, password, fullName, userType: null };
            localStorage.setItem('users', JSON.stringify(MOCK_DB.users));
            return { user: { uid: userId, email, userType: null } };
        }

        function mockSignOut() {
            MOCK_AUTH_STATE.currentUser = null;
            auth.currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentStudentSearch'); // Limpa busca do Personal
        }

        async function saveUserData(userId, data) {
            await initializeMockDB();
            MOCK_DB.users[userId] = { ...MOCK_DB.users[userId], ...data };
            localStorage.setItem('users', JSON.stringify(MOCK_DB.users));
            
            // Atualiza o userType no estado de autenticação se for alterado
            if (data.userType) {
                auth.currentUser.userType = data.userType;
                localStorage.setItem('currentUser', JSON.stringify(auth.currentUser));
            }
        }

        async function saveStudentProfileData(data) {
            const userId = auth.currentUser.uid;
            await initializeMockDB();
            MOCK_DB.studentProfiles[userId] = { ...MOCK_DB.studentProfiles[userId], ...data, userId };
            localStorage.setItem('studentProfiles', JSON.stringify(MOCK_DB.studentProfiles));
        }

        async function getStudentProfileData(userId) {
            await initializeMockDB();
            return MOCK_DB.studentProfiles[userId] || null;
        }


        // --- Simulação da IA (Gemini) ---

        // Dados estáticos para simular o Gemini
        const MOCK_GEMINI_RESPONSES = {
            'emagrecer': {
                'MOCK_PLAN_1': {
                    food: `**PLANO ALIMENTAR**
                    
**Distribuição Macro**: 40% Carboidratos, 35% Proteínas, 25% Gorduras.

**Café da Manhã (7h00)**
* 1x Omelete (2 ovos) com espinafre.
* 1x Fatia de pão integral com 1 colher de chá de azeite.
* 1x Xícara de café preto.

**Almoço (12h30)**
* 1x Porção de peito de frango grelhado (120g).
* 4x Colheres de sopa de arroz integral.
* 1x Prato grande de salada verde e tomate.
* 1x Colher de sopa de azeite extra virgem.

**Lanche da Tarde (16h00)**
* 1x Pote de iogurte natural desnatado (170g).
* 1x Porção pequena de morangos.

**Jantar (20h00)**
* 1x Porção de salmão assado (100g).
* 1x Porção de batata doce cozida (100g).
* Brócolis e Couve-flor cozidos à vontade.

**Total de Calorias Estimado na Rotina: 1550 Kcal**`,
                    training: `**PLANO DE TREINO**

**Objetivo:** Déficit Calórico e Preservação de Massa Magra (4 dias/semana)

**Dia 1: Membros Inferiores (Força)**
1.  Aquecimento: 10 minutos de Bicicleta Estacionária.
2.  Agachamento Livre: 4 séries de 10 repetições.
3.  Leg Press 45°: 3 séries de 12 repetições.
4.  Cadeira Extensora: 3 séries de 15 repetições (curta pausa).
5.  Resfriamento: 5 minutos de alongamento focado nas pernas.

**Dia 2: Membros Superiores (Peito/Tríceps)**
1.  Supino Reto com Halteres: 4 séries de 8 repetições.
2.  Crossover (Polia Alta): 3 séries de 15 repetições.
3.  Tríceps Corda (Polia): 3 séries de 15 repetições.

**Dia 3: Cardio Moderado (30 minutos)**
* Corrida/Caminhada Rápida na Esteira (Inclinação 2.0).

**Dia 4: Dorsais e Bíceps**
1.  Puxada Alta (Lat Pulldown): 4 séries de 10 repetições.
2.  Remada Curvada: 3 séries de 12 repetições.
3.  Rosca Direta com Barra: 3 séries de 12 repetições.
4.  Rosca Martelo: 3 séries de 15 repetições.

**Dia 5: Descanso Ativo/Descanso**
* (Foque no descanso e recuperação muscular.)`
                }
            },
            'massa_muscular': {
                'MOCK_PLAN_2': {
                    food: `**PLANO ALIMENTAR**
                    
**Distribuição Macro**: 50% Carboidratos, 30% Proteínas, 20% Gorduras.
Este plano é focado em superávit calórico e alta ingestão proteica.

**Café da Manhã (7h00)**
* Vitamina (1x dose de Whey Protein, 1x banana, 300ml de leite integral, 50g de aveia).
* 3x Ovos mexidos.

**Lanche da Manhã (10h00)**
* 2x Fatias de pão integral com pasta de amendoim e mel.

**Almoço (13h00)**
* 1x Porção de carne vermelha magra (150g).
* 8x Colheres de sopa de arroz branco.
* 1x Concha de feijão.
* Salada mista.

**Pré-Treino (17h00)**
* 1x Batata doce cozida média.

**Pós-Treino (19h00)**
* 1x Dose de Whey Protein com água.
* 2x Bananas.

**Jantar (21h00)**
* 1x Porção grande de frango desfiado (150g).
* Macarrão integral à bolonhesa (porção generosa).

**Total de Calorias Estimado na Rotina: 2800 Kcal**`,
                    training: `**PLANO DE TREINO**

**Objetivo:** Hipertrofia Máxima (5 dias/semana)

**Dia 1: Peito e Tríceps**
1.  Aquecimento: Rotação de ombros.
2.  Supino Inclinado com Barra: 4 séries de 8-10.
3.  Supino Reto Halteres: 3 séries de 8-10.
4.  Crucifixo: 3 séries de 12.
5.  Tríceps Testa: 3 séries de 10.
6.  Tríceps Coice: 3 séries de 12.

**Dia 2: Dorsais e Bíceps**
1.  Puxada Frente (Pegada Aberta): 4 séries de 8-10.
2.  Remada Cavalinho: 3 séries de 8-10.
3.  Pullover: 3 séries de 12.
4.  Rosca Alternada: 3 séries de 10 por braço.
5.  Rosca Concentrada: 3 séries de 12.

**Dia 3: Descanso**

**Dia 4: Membros Inferiores (Quadríceps e Panturrilha)**
1.  Agachamento Smith: 4 séries de 10 (carga alta).
2.  Hack Machine: 3 séries de 12.
3.  Extensora: 3 séries de 15 (drop-set na última).
4.  Gêmeos em Pé: 4 séries de 20.

**Dia 5: Ombros e Posteriores**
1.  Desenvolvimento Militar: 4 séries de 8-10.
2.  Elevação Lateral: 3 séries de 12-15.
3.  Posterior de Ombro (Máquina): 3 séries de 15.
4.  Cadeira Flexora: 4 séries de 10.
5.  Stiff com Halteres: 3 séries de 12.
6.  Resfriamento: Alongamento geral.
`
                }
            }
        };

        let lastMockPlanIndex = 0;

        async function mockGeminiGeneratePlan(prompt) {
            console.log("Chamando mockGeminiGeneratePlan com o prompt melhorado...");
            // Extrai o Objetivo Principal do prompt para selecionar o mock
            let objectiveMatch = prompt.match(/Objetivo Principal:\s*\*\*(.*?)\*\*/i);
            const objective = objectiveMatch ? objectiveMatch[1].toLowerCase().includes('emagrecer') ? 'emagrecer' : 'massa_muscular' : 'emagrecer';

            // Seleciona o plano mock com base no objetivo
            const plans = MOCK_GEMINI_RESPONSES[objective];
            const planKeys = Object.keys(plans);
            const planKey = planKeys[lastMockPlanIndex % planKeys.length];
            const mockPlan = plans[planKey];
            lastMockPlanIndex++; // Altera o índice para variar o plano (se houver mais)

            let foodRoutine = mockPlan.food;
            const trainingRoutine = mockPlan.training;

            // Substitui o valor Kcal do mock pelo valor da Meta Calórica do prompt para SIMULAR A ADERÊNCIA DA IA
            const calorieGoalMatch = prompt.match(/Meta Calórica Diária \(TMB Ajustada\):\s*(\d+)\s*calorias/i);
            if (calorieGoalMatch && calorieGoalMatch[1]) {
                const requiredCalorie = calorieGoalMatch[1];
                // Substitui o valor no mock para simular a resposta personalizada da IA
                foodRoutine = foodRoutine.replace(/Total de Calorias Estimado na Rotina:\s*(\d+)\s*Kcal/i, `Total de Calorias Estimado na Rotina: ${requiredCalorie} Kcal`);
            }

            // Simula um delay
            await new Promise(resolve => setTimeout(resolve, 2500)); 

            return foodRoutine + "\n\n" + trainingRoutine;
        }


        // --- Implementação do Calorie Goal (NOVA LÓGICA) ---

        // Função para calcular a Taxa Metabólica Basal (TMB) usando a fórmula de Harris-Benedict
        function calculateTMB(gender, weight, height, age) {
            if (gender === 'feminino') {
                return 655.1 + (9.563 * weight) + (1.850 * height) - (4.676 * age);
            } else if (gender === 'masculino') {
                return 66.5 + (13.75 * weight) + (5.003 * height) - (6.755 * age);
            }
            return 0;
        }

        // Fator de Atividade (assumindo moderado para fins de geração de plano)
        const ACTIVITY_FACTOR = 1.55; 

        // Função para calcular a Meta Calórica Ajustada
        function calculateCalorieGoal(gender, weight, height, age, objective) {
            const tmb = calculateTMB(gender, weight, height, age);
            const maintenanceCalories = tmb * ACTIVITY_FACTOR;

            if (objective === 'emagrecer') {
                // Déficit calórico de 15%
                return Math.round(maintenanceCalories * 0.85); 
            } else if (objective === 'massa_muscular') {
                // Superávit calórico de 15%
                return Math.round(maintenanceCalories * 1.15); 
            }
            return Math.round(maintenanceCalories); // Manutenção
        }


        // --- Variáveis DOM e Inicialização ---

        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const infoFormView = document.getElementById('info-form-view');
        const studentDashboardView = document.getElementById('student-dashboard-view');
        const personalDashboardView = document.getElementById('personal-dashboard-view');
        const planGenerationView = document.getElementById('plan-generation-view');
        const authCard = document.getElementById('auth-card');
        const messageArea = document.getElementById('message-area');

        // Forms e Inputs de Autenticação
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');

        // Inputs e Botões do Formulário de Informações
        const infoForm = document.getElementById('info-form');
        const userTypeInput = document.getElementById('user-type-input');
        const alunoFields = document.getElementById('aluno-fields');
        const alunoMetricsFields = document.getElementById('aluno-metrics-fields');
        const fullNameInput = document.getElementById('full-name');
        
        // Modals
        const foodRestrictionModal = document.getElementById('food-restriction-modal');
        const closeFoodModalBtn = document.getElementById('close-food-modal-btn');
        const addFoodRestrictionBtn = document.getElementById('add-food-restriction-btn');
        const selectedFoodTags = document.getElementById('selected-food-tags');
        const noFoodsSelected = document.getElementById('no-foods-selected');
        const foodRestrictionList = document.getElementById('food-restriction-list');
        
        const limitationsModal = document.getElementById('limitations-modal');
        const closeLimitationsModalBtn = document.getElementById('close-limitations-modal-btn');
        const addLimitationBtn = document.getElementById('add-limitation-btn');
        const selectedLimitationsTags = document.getElementById('selected-limitations-tags');
        const noLimitationsSelected = document.getElementById('no-limitations-selected');
        const limitationsList = document.getElementById('limitations-list');

        // Student Dashboard Elements
        const studentLogoutBtn = document.getElementById('student-logout-btn');
        const studentDashboardName = document.getElementById('student-dashboard-name');
        const studentDashboardEmail = document.getElementById('student-dashboard-email');
        const studentDashboardAge = document.getElementById('student-dashboard-age');
        const studentDashboardObjective = document.getElementById('student-dashboard-objective');
        const studentDashboardGender = document.getElementById('student-dashboard-gender');
        const studentDashboardWeight = document.getElementById('student-dashboard-weight');
        const studentDashboardHeight = document.getElementById('student-dashboard-height');
        const studentDashboardFoodRestrictions = document.getElementById('student-dashboard-food-restrictions');
        const studentDashboardLimitations = document.getElementById('student-dashboard-limitations');
        const studentFoodRoutine = document.getElementById('student-food-routine');
        const studentTrainingRoutine = document.getElementById('student-training-routine');
        const generatePlanBtn = document.getElementById('generate-plan-btn');
        const planStatus = document.getElementById('plan-status');

        // NOVOS ELEMENTOS DO DASHBOARD DO ALUNO (CALORIAS)
        const studentDashboardCalorieGoal = document.getElementById('student-dashboard-calorie-goal'); 
        const studentFoodRoutineCalories = document.getElementById('student-food-routine-calories'); 

        // Personal Dashboard Elements
        const personalLogoutBtn = document.getElementById('personal-logout-btn');
        const personalDashboardName = document.getElementById('personal-dashboard-name');
        const searchStudentForm = document.getElementById('search-student-form');
        const studentIdInput = document.getElementById('student-id-input');
        const searchMessage = document.getElementById('search-message');
        const editRoutineSection = document.getElementById('edit-routine-section');
        const searchedStudentName = document.getElementById('searched-student-name');
        const searchedStudentEmail = document.getElementById('searched-student-email');
        const searchedStudentDetails = document.getElementById('searched-student-details');
        const searchedStudentCalorieGoal = document.getElementById('searched-student-calorie-goal'); // Novo
        const editStudentRoutineForm = document.getElementById('edit-student-routine-form');
        const editFoodRoutine = document.getElementById('edit-food-routine');
        const editTrainingRoutine = document.getElementById('edit-training-routine');
        const editMessage = document.getElementById('edit-message');

        // Dados Compartilhados
        let selectedFoodRestrictions = [];
        let selectedLimitations = [];
        let searchedStudentData = null; // Para armazenar os dados do aluno buscado pelo Personal

        const ALL_FOOD_RESTRICTIONS = [
            'Glúten', 'Lactose', 'Ovos', 'Amendoim', 'Oleaginosas (Nozes, Amêndoas)', 
            'Frutos do Mar', 'Soja', 'Trigo', 'Carne Vermelha', 'Vegetariano', 'Vegano',
            'Comida Japonesa', 'Fast Food', 'Refrigerantes'
        ];
        const ALL_LIMITATIONS = [
            'Dor Lombar Crônica', 'Dor no Joelho (Condromalácia)', 'Dor no Ombro', 
            'Problemas Cardíacos', 'Lesão no Manguito Rotador', 'Hérnia de Disco', 
            'Pressão Alta', 'Diabetes'
        ];


        // --- Funções de UI ---

        function toggleView(view) {
            const views = {
                'login': loginView,
                'register': registerView,
                'info': infoFormView,
                'student': studentDashboardView,
                'personal': personalDashboardView,
                'generation': planGenerationView
            };
            
            // Redimensiona o card principal para as telas de login/registro/info
            const isSmallCard = ['login', 'register', 'info'].includes(view);
            if (isSmallCard) {
                authCard.classList.add('max-w-md');
                authCard.classList.remove('max-w-4xl');
            } else {
                authCard.classList.remove('max-w-md');
                authCard.classList.add('max-w-4xl');
            }

            // Oculta todas as views e mostra a view atual
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[view]) {
                views[view].classList.remove('hidden');
            }
        }

        function displayMessage(type, text) {
            messageArea.textContent = text;
            messageArea.classList.remove('hidden', 'bg-red-500', 'bg-green-500', 'text-white');
            if (type === 'error') {
                messageArea.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                messageArea.classList.add('bg-green-500', 'text-white');
            }
        }
        
        function clearMessage() {
            messageArea.classList.add('hidden');
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                document.getElementById('sun-icon').classList.remove('hidden');
                document.getElementById('moon-icon').classList.add('hidden');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.remove('light');
                document.documentElement.classList.add('dark');
                document.getElementById('sun-icon').classList.add('hidden');
                document.getElementById('moon-icon').classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.documentElement.classList.remove('dark');
                document.documentElement.classList.add('light');
                document.getElementById('sun-icon').classList.remove('hidden');
                document.getElementById('moon-icon').classList.add('hidden');
            }
        }

        // --- Funções de Limitações e Restrições (Modais) ---

        function renderTags(container, dataArray, tagClass) {
            container.innerHTML = '';
            if (dataArray.length === 0) {
                container.innerHTML = `<span class="text-sm dark:text-gray-400 light:text-gray-500">Nenhum(a) selecionado(a).</span>`;
                return;
            }
            dataArray.forEach(item => {
                const tag = document.createElement('span');
                tag.className = `${tagClass} food-tag flex items-center bg-indigo-600 dark:bg-indigo-600 light:bg-indigo-500`;
                tag.innerHTML = `${item}`;
                container.appendChild(tag);
            });
        }

        function renderCheckboxes(listElement, allItems, selectedItems, type) {
            listElement.innerHTML = '';
            allItems.forEach(item => {
                const isChecked = selectedItems.includes(item);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center';
                itemDiv.innerHTML = `
                    <input id="${type}-${item.replace(/\s/g, '-')}" type="checkbox" value="${item}" ${isChecked ? 'checked' : ''}
                           class="w-4 h-4 text-indigo-600 bg-gray-600 border-gray-500 rounded focus:ring-indigo-500">
                    <label for="${type}-${item.replace(/\s/g, '-')}" class="ml-2 text-sm font-medium dark:text-gray-300 light:text-gray-700">${item}</label>
                `;
                itemDiv.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!selectedItems.includes(item)) selectedItems.push(item);
                    } else {
                        const index = selectedItems.indexOf(item);
                        if (index > -1) selectedItems.splice(index, 1);
                    }
                    if (type === 'food') {
                        renderTags(selectedFoodTags, selectedFoodRestrictions, 'food-tag');
                    } else {
                        renderTags(selectedLimitationsTags, selectedLimitations, 'limitation-tag');
                    }
                });
                listElement.appendChild(itemDiv);
            });
        }

        function renderFoodTags() {
            renderTags(selectedFoodTags, selectedFoodRestrictions, 'food-tag');
            renderCheckboxes(foodRestrictionList, ALL_FOOD_RESTRICTIONS, selectedFoodRestrictions, 'food');
        }

        function openFoodModal() {
            renderCheckboxes(foodRestrictionList, ALL_FOOD_RESTRICTIONS, selectedFoodRestrictions, 'food');
            foodRestrictionModal.classList.remove('hidden');
        }
        function closeFoodModal() {
            foodRestrictionModal.classList.add('hidden');
        }

        function renderLimitationTags() {
            renderTags(selectedLimitationsTags, selectedLimitations, 'limitation-tag');
            renderCheckboxes(limitationsList, ALL_LIMITATIONS, selectedLimitations, 'limitation');
        }
        function openLimitationsModal() {
            renderCheckboxes(limitationsList, ALL_LIMITATIONS, selectedLimitations, 'limitation');
            limitationsModal.classList.remove('hidden');
        }
        function closeLimitationsModal() {
            limitationsModal.classList.add('hidden');
        }
        
        // --- Funções Principais de Roteamento/Renderização ---

        function updateInfoForm(userData) {
            fullNameInput.value = userData.fullName || '';
            userTypeInput.value = userData.userType || '';
            
            // Campos de Aluno
            if (userData.userType === 'aluno') {
                alunoFields.classList.remove('hidden');
                document.getElementById('age').value = userData.age || '';
                document.getElementById('gender').value = userData.gender || '';
                document.getElementById('objective').value = userData.objective || '';
                document.getElementById('weight').value = userData.weight || '';
                document.getElementById('height').value = userData.height || '';
                
                selectedFoodRestrictions = userData.foodRestrictions || [];
                selectedLimitations = userData.limitations || [];
                renderFoodTags();
                renderLimitationTags();
            } else {
                 alunoFields.classList.add('hidden');
                 // Limpa dados de aluno no formulário se o tipo for Personal
                 document.getElementById('age').value = '';
                 document.getElementById('gender').value = '';
                 document.getElementById('objective').value = '';
                 document.getElementById('weight').value = '';
                 document.getElementById('height').value = '';
            }
        }

        async function renderStudentDashboard(userData, profileData) {
            studentDashboardName.textContent = userData.fullName || userData.email;
            studentDashboardEmail.textContent = userData.email;

            if (profileData) {
                studentDashboardAge.textContent = profileData.age ? `${profileData.age} anos` : 'N/A';
                studentDashboardObjective.textContent = profileData.objective || 'N/A';
                studentDashboardGender.textContent = profileData.gender || 'N/A';
                studentDashboardWeight.textContent = profileData.weight ? `${profileData.weight} kg` : 'N/A';
                studentDashboardHeight.textContent = profileData.height ? `${profileData.height} cm` : 'N/A';
                
                // NOVO: Meta Calórica
                studentDashboardCalorieGoal.textContent = profileData.calorieGoal ? `${profileData.calorieGoal} Kcal` : 'N/A';
                
                // Rotinas
                studentFoodRoutine.textContent = profileData.foodRoutine || 'Aguardando geração do plano.';
                studentTrainingRoutine.textContent = profileData.trainingRoutine || 'Aguardando geração do plano.';
                
                // NOVO: Total de Calorias da Rotina
                studentFoodRoutineCalories.textContent = profileData.totalRoutineCalories ? `${profileData.totalRoutineCalories} Kcal` : 'Aguardando geração...';
                
                // Restrições e Limitações
                renderTags(studentDashboardFoodRestrictions, profileData.foodRestrictions || [], 'food-tag');
                renderTags(studentDashboardLimitations, profileData.limitations || [], 'limitation-tag');
                
                generatePlanBtn.disabled = !profileData.age || !profileData.objective; // Desabilita se faltarem dados essenciais
            } else {
                // Limpa campos se não houver profileData
                studentDashboardAge.textContent = studentDashboardObjective.textContent = studentDashboardGender.textContent = studentDashboardWeight.textContent = studentDashboardHeight.textContent = 'N/A';
                studentDashboardCalorieGoal.textContent = 'N/A';
                studentFoodRoutine.textContent = studentTrainingRoutine.textContent = 'Aguardando preenchimento do perfil para gerar o plano.';
                studentFoodRoutineCalories.textContent = 'Aguardando geração...';
                studentDashboardFoodRestrictions.innerHTML = '<span class="dark:text-gray-400 light:text-gray-500">Nenhuma.</span>';
                studentDashboardLimitations.innerHTML = '<span class="dark:text-gray-400 light:text-gray-500">Nenhuma.</span>';
                generatePlanBtn.disabled = true;
            }
            toggleView('student');
        }

        async function renderPersonalDashboard(userData) {
            personalDashboardName.textContent = userData.fullName || userData.email;
            toggleView('personal');

            // Limpa a busca anterior ao entrar no dashboard
            editRoutineSection.classList.add('hidden');
            searchMessage.classList.add('hidden');
            searchedStudentData = null;
        }

        async function handleAuthStateChange(user) {
            clearMessage();
            if (user) {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                if (!userData || !userData.userType) {
                    // Novo usuário ou usuário sem informações de perfil
                    toggleView('info');
                    // Tenta pré-popular o nome se estiver disponível na mock auth (Google)
                    fullNameInput.value = userData?.fullName || ''; 
                    
                } else if (userData.userType === 'aluno') {
                    const profileData = await getStudentProfileData(user.uid);
                    await renderStudentDashboard({ ...userData, ...profileData }, { ...userData, ...profileData });
                } else if (userData.userType === 'personal') {
                    await renderPersonalDashboard(userData);
                }
            } else {
                toggleView('login');
            }
        }

        // --- Funções de Event Handlers ---

        function handleLogout() {
            mockSignOut();
            handleAuthStateChange(null);
            clearMessage();
        }

        // --- Formulários de Autenticação ---

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessage();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await mockSignIn(email, password);
                handleAuthStateChange(auth.currentUser);
            } catch (error) {
                displayMessage('error', error.message);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessage();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            const fullName = document.getElementById('register-name').value;

            if (password.length < 6) {
                return displayMessage('error', 'A senha deve ter no mínimo 6 caracteres.');
            }
            if (password !== confirmPassword) {
                return displayMessage('error', 'As senhas não coincidem.');
            }
            
            try {
                await mockSignUp(email, password, fullName);
                // Após o cadastro, faz login e direciona para o form de info
                await mockSignIn(email, password);
                handleAuthStateChange(auth.currentUser);
            } catch (error) {
                displayMessage('error', error.message);
            }
        });

        // Simulação de Login com Google (apenas simula o login no sistema)
        googleLoginBtn.addEventListener('click', async () => {
             // Simula um login de sucesso para um usuário 'google_user'
             const email = 'google_user@mock.com';
             const password = 'mockpassword';
             const fullName = 'Usuário Google Mock';

             try {
                // Tenta fazer login, se falhar (usuário novo), cadastra e loga
                await mockSignIn(email, password);
            } catch (error) {
                if (error.message.includes('inválidos')) {
                    // Usuário não existe, cadastra
                    await mockSignUp(email, password, fullName);
                    await mockSignIn(email, password);
                } else {
                    return displayMessage('error', error.message);
                }
            }
            handleAuthStateChange(auth.currentUser);
        });

        // --- Formulário de Informações de Perfil ---

        userTypeInput.addEventListener('change', (e) => {
            if (e.target.value === 'aluno') {
                alunoFields.classList.remove('hidden');
                alunoMetricsFields.querySelectorAll('input, select').forEach(el => el.setAttribute('required', ''));
            } else {
                alunoFields.classList.add('hidden');
                alunoMetricsFields.querySelectorAll('input, select').forEach(el => el.removeAttribute('required'));
            }
        });

        infoForm.addEventListener('submit', handleInfoFormSubmit);
        
        async function handleInfoFormSubmit(e) {
            e.preventDefault();
            clearMessage();

            const userType = userTypeInput.value;
            const fullName = fullNameInput.value;
            const userId = auth.currentUser.uid;
            
            // Dados básicos
            const userData = {
                userType,
                fullName
            };
            
            // Dados de Perfil do Aluno (se aplicável)
            let profileData = {};
            let calorieGoal = null;
            if (userType === 'aluno') {
                const age = document.getElementById('age').value;
                const gender = document.getElementById('gender').value;
                const objective = document.getElementById('objective').value;
                const weight = document.getElementById('weight').value;
                const height = document.getElementById('height').value;
                
                // Validações básicas
                if (!age || !gender || !objective || !weight || !height) {
                    return displayMessage('error', 'Por favor, preencha todos os campos métricos obrigatórios para o Aluno.');
                }
                
                // CALCULA A META CALÓRICA (NOVA LÓGICA)
                calorieGoal = calculateCalorieGoal(gender, parseFloat(weight), parseFloat(height), parseInt(age), objective);


                profileData = {
                    age: parseInt(age),
                    gender,
                    objective,
                    weight: parseFloat(weight),
                    height: parseInt(height),
                    foodRestrictions: selectedFoodRestrictions,
                    limitations: selectedLimitations,
                    calorieGoal: calorieGoal, // NOVO CAMPO
                    // Mantém rotina existente ou inicia como nulo
                    foodRoutine: (await getStudentProfileData(userId))?.foodRoutine || null,
                    trainingRoutine: (await getStudentProfileData(userId))?.trainingRoutine || null,
                    totalRoutineCalories: (await getStudentProfileData(userId))?.totalRoutineCalories || null, // NOVO CAMPO
                };
            }

            try {
                // Salva os dados básicos (Nome e Tipo)
                await saveUserData(userId, userData);

                if (userType === 'aluno') {
                    // Salva os dados de perfil do aluno (incluindo calorieGoal)
                    await saveStudentProfileData(profileData);
                    await renderStudentDashboard({ ...auth.currentUser, ...userData }, profileData);

                } else if (userType === 'personal') {
                    await renderPersonalDashboard({ ...auth.currentUser, ...userData });
                }

                displayMessage('success', 'Informações salvas com sucesso!');
                
            } catch (error) {
                displayMessage('error', 'Erro ao salvar informações: ' + error.message);
            }
        }

        // --- Geração de Plano (IA - Gemini) ---

        generatePlanBtn.addEventListener('click', handleGeneratePlan);

        async function handleGeneratePlan() {
            const userId = auth.currentUser.uid;
            const userData = await db.collection('users').doc(userId).get().then(doc => doc.data());
            const profileData = await getStudentProfileData(userId);

            if (!profileData || !profileData.age || !profileData.objective || !profileData.calorieGoal) {
                planStatus.textContent = 'Erro: Faltam dados essenciais (Idade, Objetivo, Meta Calórica) para gerar o plano.';
                planStatus.classList.remove('hidden');
                return;
            }

            generatePlanBtn.disabled = true;
            generatePlanBtn.innerHTML = `
                <svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Gerando...
            `;
            planStatus.textContent = 'Gerando plano... isso pode levar alguns segundos.';
            planStatus.classList.remove('hidden');
            
            const objectiveDescription = profileData.objective === 'emagrecer' ? 'Emagrecimento e Definição Muscular' : 'Ganho de Massa Muscular (Hipertrofia)';
            const restrictions = profileData.foodRestrictions || [];
            const limitations = profileData.limitations || [];
            const calorieGoal = profileData.calorieGoal || '2000';

            const foodRestrictionsText = restrictions.length > 0 ? `Ele(a) possui restrições alimentares severas: ${restrictions.join(', ')}.` : 'Ele(a) não possui restrições alimentares notáveis.';
            const physicalLimitationsText = limitations.length > 0 ? `Ele(a) tem as seguintes limitações físicas que DEVEM ser consideradas no treino: ${limitations.join(', ')}.` : 'Ele(a) não possui limitações físicas, o treino pode ser completo.';

            // PROMPT MELHORADO PARA GARANTIR ESTRUTURA, PERSONALIZAÇÃO E CALORIAS TOTAIS
            const prompt = `Você é um Personal Trainer e Nutricionista IA avançado. Sua missão é gerar um plano **altamente personalizado** e completo (alimentar e de treino) para um aluno com base nos seguintes dados, garantindo que o plano seja motivacional, seguro e eficaz.

---
**DADOS DO ALUNO:**
- Nome: ${userData.fullName}
- Idade: ${profileData.age} anos
- Gênero: ${profileData.gender}
- Peso: ${profileData.weight} kg
- Altura: ${profileData.height} cm
- Objetivo Principal: **${objectiveDescription}**
- **Meta Calórica Diária (TMB Ajustada): ${calorieGoal} calorias.**
- Restrições Alimentares: ${foodRestrictionsText}
- Limitações Físicas: ${physicalLimitationsText}
---

**REQUISITOS OBRIGATÓRIOS PARA O PLANO ALIMENTAR:**

1.  **Individualização:** O plano deve ser único e focado em alimentos que se adequam ao **Objetivo Principal** e **Meta Calórica** do aluno. Use ${foodRestrictionsText} para evitar alimentos proibidos.
2.  **Distribuição de Macronutrientes:** Sugira uma distribuição macro (ex: Proteína/Gordura/Carboidrato) que apoie o objetivo.
3.  **Contagem Calórica:** O total de calorias estimado desta rotina deve ser o mais próximo possível da meta de **${calorieGoal} calorias**.
4.  **FORMATO OBRIGATÓRIO (para extração de dados):** No **FINAL** da rotina alimentar (e *apenas* nesta seção), inclua **obrigatoriamente** a frase exata: **"Total de Calorias Estimado na Rotina: X Kcal"**, substituindo **X** pelo valor total da rotina (apenas o número).

**REQUISITOS OBRIGATÓRIOS PARA O PLANO DE TREINO:**

1.  **Personalização:** Sugira uma rotina semanal de 4 a 5 dias. Leve em consideração as ${physicalLimitationsText}.
2.  **Estrutura:** Inclua Aquecimento, Exercícios (com séries/repetições) e Resfriamento.

**FORMATO DE SAÍDA:**

Sua resposta DEVE ser dividida em duas seções principais usando os títulos **exatos** abaixo. Mantenha os títulos em negrito no topo de cada seção.

**PLANO ALIMENTAR**
[Conteúdo do plano alimentar detalhado, seguindo os requisitos acima, terminando com a frase de contagem calórica.]

**PLANO DE TREINO**
[Conteúdo do plano de treino detalhado, seguindo os requisitos acima.]
`;

            try {
                const resultText = await mockGeminiGeneratePlan(prompt);
                
                const parts = resultText.split('**PLANO DE TREINO**');
                if (parts.length < 2) throw new Error('O formato da resposta da IA está incorreto.');

                const foodSection = parts[0];
                const trainingSection = parts[1];

                // Remove o título do plano de treino e a quebra de linha
                const foodRoutine = foodSection.replace('**PLANO ALIMENTAR**', '').trim();
                const trainingRoutine = trainingSection.trim();

                // LÓGICA DE EXTRAÇÃO DO TOTAL DE CALORIAS DA ROTINA
                let totalRoutineCalories = 'N/A';
                // Expressão regular para encontrar a frase obrigatória, capturando o número X (apenas dígitos)
                const calorieMatch = foodRoutine.match(/Total de Calorias Estimado na Rotina:\s*(\d+)\s*Kcal/i);
                
                if (calorieMatch && calorieMatch[1]) {
                    totalRoutineCalories = calorieMatch[1]; // Captura o número
                }

                // Salva o novo plano e o total de calorias
                await saveStudentProfileData({
                    foodRoutine,
                    trainingRoutine,
                    totalRoutineCalories // NOVO CAMPO SALVO
                });

                // Atualiza o dashboard
                await renderStudentDashboard(userData, { ...profileData, foodRoutine, trainingRoutine, totalRoutineCalories });

                planStatus.textContent = 'Plano gerado e salvo com sucesso!';
                planStatus.classList.remove('hidden');

            } catch (error) {
                console.error('Erro na geração do plano:', error);
                planStatus.textContent = 'Erro ao gerar o plano. Tente novamente.';
                planStatus.classList.remove('hidden');
            } finally {
                generatePlanBtn.disabled = false;
                generatePlanBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Gerar Plano de Ação (Alimentar e Treino)
                `;
            }
        }

        // --- Funções do Personal Trainer ---

        async function handleSearchStudent(e) {
            e.preventDefault();
            searchMessage.classList.add('hidden');
            editRoutineSection.classList.add('hidden');

            const studentId = studentIdInput.value;
            if (!studentId) return;

            // Busca os dados do aluno na coleção de perfis e depois na de usuários para o nome/email
            const profileDoc = await db.collection('studentProfiles').doc(studentId).get();
            const userDoc = await db.collection('users').doc(studentId).get();
            
            const profileData = profileDoc.data();
            const userData = userDoc.data();

            if (profileData && userData && userData.userType === 'aluno') {
                searchedStudentData = { ...userData, ...profileData };
                
                searchedStudentName.textContent = searchedStudentData.fullName;
                searchedStudentEmail.textContent = searchedStudentData.email;
                searchedStudentCalorieGoal.textContent = searchedStudentData.calorieGoal ? `${searchedStudentData.calorieGoal} Kcal` : 'N/A';
                
                // Exibe restrições e limitações de forma legível
                const restrictions = (searchedStudentData.foodRestrictions || []).join(', ') || 'Nenhuma';
                const limitations = (searchedStudentData.limitations || []).join(', ') || 'Nenhuma';
                searchedStudentDetails.textContent = `Restrições: ${restrictions}. Limitações: ${limitations}.`;

                editFoodRoutine.value = searchedStudentData.foodRoutine || 'Plano Alimentar não gerado. Clique em "Salvar Alterações" para iniciar o plano.';
                editTrainingRoutine.value = searchedStudentData.trainingRoutine || 'Plano de Treino não gerado. Clique em "Salvar Alterações" para iniciar o plano.';

                editRoutineSection.classList.remove('hidden');
                editMessage.classList.add('hidden');
                
                // Salva o ID da busca atual para uso no Submit (caso o Personal modifique e salve)
                localStorage.setItem('currentStudentSearch', studentId);

            } else {
                searchMessage.textContent = 'Aluno não encontrado ou ID inválido.';
                searchMessage.classList.remove('hidden');
                editRoutineSection.classList.add('hidden');
            }
        }

        async function handleEditRoutineSubmit(e) {
            e.preventDefault();
            editMessage.classList.add('hidden');

            const studentId = localStorage.getItem('currentStudentSearch');
            if (!studentId || !searchedStudentData) {
                editMessage.textContent = 'Erro: Nenhum aluno selecionado para edição.';
                editMessage.classList.remove('hidden', 'dark:text-green-400');
                editMessage.classList.add('dark:text-red-400', 'light:text-red-600');
                return;
            }
            
            const newFoodRoutine = editFoodRoutine.value;
            const newTrainingRoutine = editTrainingRoutine.value;

            try {
                // LÓGICA DE EXTRAÇÃO DO TOTAL DE CALORIAS DA ROTINA EDITADA
                let totalRoutineCalories = searchedStudentData.totalRoutineCalories || 'N/A';
                // Tenta extrair o novo valor calórico, se o Personal o incluiu no formato certo
                const calorieMatch = newFoodRoutine.match(/Total de Calorias Estimado na Rotina:\s*(\d+)\s*Kcal/i);
                
                if (calorieMatch && calorieMatch[1]) {
                    totalRoutineCalories = calorieMatch[1];
                } else {
                    // Se o Personal não incluiu o formato, mantém o valor antigo se existir
                    totalRoutineCalories = searchedStudentData.totalRoutineCalories || 'N/A';
                }

                // Salva os dados editados
                await db.collection('studentProfiles').doc(studentId).set({
                    foodRoutine: newFoodRoutine,
                    trainingRoutine: newTrainingRoutine,
                    totalRoutineCalories: totalRoutineCalories // Salva o novo valor ou o antigo
                }, { merge: true });

                // Atualiza os dados locais de busca
                searchedStudentData.foodRoutine = newFoodRoutine;
                searchedStudentData.trainingRoutine = newTrainingRoutine;
                searchedStudentData.totalRoutineCalories = totalRoutineCalories;
                
                editMessage.textContent = 'Rotina e contagem calórica atualizadas com sucesso!';
                editMessage.classList.remove('hidden', 'dark:text-red-400', 'light:text-red-600');
                editMessage.classList.add('dark:text-green-400', 'light:text-green-700');

            } catch (error) {
                editMessage.textContent = 'Erro ao salvar alterações: ' + error.message;
                editMessage.classList.remove('hidden', 'dark:text-green-400', 'light:text-green-700');
                editMessage.classList.add('dark:text-red-400', 'light:text-red-600');
            }
        }


        // --- Listeners e Inicialização ---

        // Inicia a verificação do estado de autenticação e carrega o tema
        auth.onAuthStateChanged(handleAuthStateChange);
        loadTheme();
        
        // Listeners de Forms
        loginForm.addEventListener('submit', (e) => e.preventDefault()); // Re-adicionado para garantir
        registerForm.addEventListener('submit', (e) => e.preventDefault()); // Re-adicionado para garantir
        infoForm.addEventListener('submit', (e) => e.preventDefault()); // Re-adicionado para garantir

        // Listeners de Login
        document.getElementById('show-register-link').addEventListener('click', (e) => {
            e.preventDefault();
            toggleView('register');
        });
        document.getElementById('show-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            toggleView('login');
        });
        
        // Listeners de Logout dos Dashboards
        studentLogoutBtn.addEventListener('click', handleLogout);
        personalLogoutBtn.addEventListener('click', handleLogout);
        
        // Adiciona o listener para o botão de tema
        document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode); 

        // Listeners para as funcionalidades de Alimentos e Limitações
        addFoodRestrictionBtn.addEventListener('click', openFoodModal);
        closeFoodModalBtn.addEventListener('click', closeFoodModal);
        addLimitationBtn.addEventListener('click', openLimitationsModal);
        closeLimitationsModalBtn.addEventListener('click', closeLimitationsModal);
        
        // Listeners do Personal Trainer Dashboard
        searchStudentForm.addEventListener('submit', handleSearchStudent);
        editStudentRoutineForm.addEventListener('submit', handleEditRoutineSubmit);

        // Renderização inicial
        renderLimitationTags();
        renderFoodTags();
    </script>
</body>
</html>
